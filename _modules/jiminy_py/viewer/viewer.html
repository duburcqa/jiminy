

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>jiminy_py.viewer.viewer &mdash; jiminy 1.8.12 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/documentation_options.js?v=32cf9813"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            jiminy
              <img src="../../../_static/jiminy_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">README</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Key features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#gym-jiminy">Gym Jiminy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#demo">Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#getting-started">Getting started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">INSTALLATION</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../INSTALL.html">Easy-install on Ubuntu 18+</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../INSTALL.html#building-from-source">Building from source</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TUTORIALS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">An introduction to Jiminy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API DOC</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/jiminy/index.html">Jiminy C++ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/jiminy_py/index.html">Jiminy Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gym_jiminy/common/index.html">Gym Jiminy API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Technical Specifications</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../spec/src/tlmc_format_specification.html">HDF5 telemetry log format (TLMC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../spec/pdf/index.html">Downloadable PDF</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">jiminy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">jiminy_py.viewer.viewer</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for jiminy_py.viewer.viewer</h1><div class="highlight"><pre>
<span></span><span class="c1"># mypy: disable-error-code=&quot;attr-defined, name-defined&quot;</span>
<span class="sd">&quot;&quot;&quot;This module provides a backend-agnostic 3D viewer on top of lower-level</span>
<span class="sd">implementations.</span>

<span class="sd">This viewer can be used to render the state of a robot, including sensor data</span>
<span class="sd">and external forces if any. It is mainly used to render the current simulation</span>
<span class="sd">state or replay multiple complete trajectories as-posteriori.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">webbrowser</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="kn">import</span> <span class="n">TracebackException</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span><span class="p">,</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">RLock</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span> <span class="k">as</span> <span class="n">ProcessMP</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span> <span class="n">overload</span><span class="p">,</span> <span class="n">cast</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">panda3d_viewer.viewer_errors</span> <span class="kn">import</span> <span class="n">ViewerError</span><span class="p">,</span> <span class="n">ViewerClosedError</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">psutil</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">Process</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># type: ignore[assignment,misc]</span>

<span class="kn">import</span> <span class="nn">hppfcl</span>
<span class="kn">import</span> <span class="nn">pinocchio</span> <span class="k">as</span> <span class="nn">pin</span>
<span class="kn">from</span> <span class="nn">pinocchio</span> <span class="kn">import</span> <span class="n">SE3</span><span class="p">,</span> <span class="n">SE3ToXYZQUAT</span>
<span class="kn">from</span> <span class="nn">pinocchio.rpy</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># pylint: disable=import-error</span>
    <span class="n">rpyToMatrix</span><span class="p">,</span> <span class="n">matrixToRpy</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">core</span> <span class="k">as</span> <span class="n">jiminy</span>
<span class="kn">from</span> <span class="nn">..core</span> <span class="kn">import</span> <span class="n">ContactSensor</span>  <span class="c1"># pylint: disable=no-name-in-module</span>
<span class="kn">from</span> <span class="nn">..robot</span> <span class="kn">import</span> <span class="n">_DuplicateFilter</span>
<span class="kn">from</span> <span class="nn">..dynamics</span> <span class="kn">import</span> <span class="n">Trajectory</span>
<span class="kn">from</span> <span class="nn">..log</span> <span class="kn">import</span> <span class="n">UpdateHook</span>
<span class="kn">from</span> <span class="nn">.meshcat.utilities</span> <span class="kn">import</span> <span class="n">interactive_mode</span>
<span class="kn">from</span> <span class="nn">.panda3d.panda3d_visualizer</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Tuple3FType</span><span class="p">,</span> <span class="n">Tuple4FType</span><span class="p">,</span> <span class="n">ShapeType</span><span class="p">,</span> <span class="n">Panda3dApp</span><span class="p">,</span> <span class="n">Panda3dViewer</span><span class="p">,</span>
    <span class="n">Panda3dVisualizer</span><span class="p">,</span> <span class="n">convert_bvh_collision_geometry_to_primitive</span><span class="p">)</span>


<span class="n">REPLAY_FRAMERATE</span> <span class="o">=</span> <span class="mi">30</span>

<span class="n">CAMERA_INV_TRANSFORM_PANDA3D</span> <span class="o">=</span> <span class="n">rpyToMatrix</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="n">CAMERA_INV_TRANSFORM_MESHCAT</span> <span class="o">=</span> <span class="n">rpyToMatrix</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="n">DEFAULT_CAMERA_XYZRPY_ABS</span> <span class="o">=</span> <span class="p">((</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
<span class="n">DEFAULT_CAMERA_XYZRPY_REL</span> <span class="o">=</span> <span class="p">((</span><span class="mf">4.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.1</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.35</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span>

<span class="n">DEFAULT_WATERMARK_MAXSIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>

<span class="c1"># Fz force value corresponding to capsule&#39;s length of 1m</span>
<span class="n">CONTACT_FORCE_SCALE</span> <span class="o">=</span> <span class="mf">10000.0</span>  <span class="c1"># [N]</span>
<span class="n">EXTERNAL_FORCE_SCALE</span> <span class="o">=</span> <span class="mf">800.0</span>  <span class="c1"># [N]</span>

<span class="n">COLORS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;red&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
          <span class="s1">&#39;blue&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
          <span class="s1">&#39;green&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
          <span class="s1">&#39;yellow&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
          <span class="s1">&#39;purple&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
          <span class="s1">&#39;orange&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
          <span class="s1">&#39;pink&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
          <span class="s1">&#39;grey&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
          <span class="s1">&#39;cyan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
          <span class="s1">&#39;white&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
          <span class="s1">&#39;black&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)}</span>


<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">_DuplicateFilter</span><span class="p">())</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">interp1d</span><span class="p">(</span><span class="n">t_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">y_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">t_out</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">interp1d</span><span class="p">(</span><span class="n">t_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">y_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">t_out</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="o">...</span>


<span class="k">def</span> <span class="nf">interp1d</span><span class="p">(</span><span class="n">t_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">y_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">t_out</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;One-dimensional linear interpolation for monotonically increasing sample</span>
<span class="sd">    points.</span>

<span class="sd">    :param t_in: The time of the input data points, must be increasing.</span>
<span class="sd">    :param y_in: The value of the data points, same length as `t_in`.</span>
<span class="sd">    :param t_out: The time at which to evaluate the interpolated values.</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        This method generalizes `numpy.interp`. It is similar to</span>
<span class="sd">        `scipy.interpolate.interp1d`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">is_scalar</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_out</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_scalar</span><span class="p">:</span>
        <span class="n">t_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t_out</span><span class="p">])</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_out</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">y_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">t_out</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">y_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t_out</span><span class="p">,</span> <span class="n">y_out</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t_in</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">t_in</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t_in</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_in</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">t_in</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_in</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">y</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">y_in</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span> <span class="o">*</span> <span class="n">y_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">y</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">y_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">y_in</span><span class="p">[</span><span class="n">t_in</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">y_out</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_scalar</span> <span class="k">else</span> <span class="n">y_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<div class="viewcode-block" id="is_display_available">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.is_display_available">[docs]</a>
<span class="k">def</span> <span class="nf">is_display_available</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if graphical server is available locally for onscreen rendering</span>
<span class="sd">    or if the viewer can be opened in an interactive cell.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">interactive_mode</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">daemon</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;linux&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DISPLAY&quot;</span><span class="p">):</span>  <span class="c1"># type: ignore[unreachable,unused-ignore]</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="get_default_backend">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.get_default_backend">[docs]</a>
<span class="k">def</span> <span class="nf">get_default_backend</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the default backend viewer, depending eventually on the</span>
<span class="sd">    running environment, hardware, and set of available backends.</span>

<span class="sd">    Panda3d is preferred over Meshcat in non-interactive mode, and on Google</span>
<span class="sd">    Colaboratory because of known latency issue making it unusable.</span>
<span class="sd">    See https://github.com/googlecolab/colabtools/issues/2870</span>

<span class="sd">    .. note::</span>
<span class="sd">        Both Meshcat and Panda3d supports Nvidia EGL rendering without</span>
<span class="sd">        graphical server. Besides, both can fallback to software rendering if</span>
<span class="sd">        necessary, although Panda3d offers only very limited support of it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">interactive_mode</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">get_backend_type</span><span class="p">(</span><span class="s1">&#39;meshcat&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;meshcat&#39;</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="s1">&#39;panda3d-sync&#39;</span>
    <span class="k">if</span> <span class="n">is_display_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;JIMINY_VIEWER_DEFAULT_BACKEND&#39;</span><span class="p">,</span> <span class="s1">&#39;panda3d&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;panda3d-sync&#39;</span></div>



<span class="k">def</span> <span class="nf">get_backend_type</span><span class="p">(</span><span class="n">backend_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return backend entry-point from its name if available.</span>

<span class="sd">    .. note::</span>
<span class="sd">        It is a function because otherwise it would only be run once at</span>
<span class="sd">        import by the main thread only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=import-outside-toplevel,unused-import</span>
    <span class="k">if</span> <span class="n">backend_name</span> <span class="o">==</span> <span class="s2">&quot;panda3d-sync&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Panda3dVisualizer</span>
    <span class="k">if</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">daemon</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Please use backend &#39;panda3d-sync&#39; in daemon thread.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">backend_name</span> <span class="o">==</span> <span class="s2">&quot;panda3d&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">interactive_mode</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Synchronous &#39;panda3d&#39; backend is disabled in interactive &quot;</span>
                <span class="s2">&quot;mode. Consider using asynchronous &#39;panda3d-sync&#39; instead.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Panda3dVisualizer</span>
    <span class="k">if</span> <span class="n">backend_name</span> <span class="o">==</span> <span class="s2">&quot;panda3d-qt&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.panda3d.panda3d_widget</span> <span class="kn">import</span> <span class="n">Panda3dQWidget</span>  <span class="c1"># noqa: F401</span>
            <span class="k">return</span> <span class="n">Panda3dVisualizer</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;panda3d-qt&#39; backend is not available. Please install either &quot;</span>
                <span class="s2">&quot;&#39;pyqt5&#39; or &#39;pyside6&#39;.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">if</span> <span class="n">backend_name</span> <span class="o">==</span> <span class="s2">&quot;meshcat&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>  <span class="c1"># noqa: F401</span>
            <span class="kn">from</span> <span class="nn">.meshcat.wrapper</span> <span class="kn">import</span> <span class="n">MeshcatWrapper</span>  <span class="c1"># noqa: F401</span>
            <span class="kn">from</span> <span class="nn">.meshcat.meshcat_visualizer</span> <span class="kn">import</span> <span class="n">MeshcatVisualizer</span>
            <span class="k">return</span> <span class="n">MeshcatVisualizer</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;meshcat&#39; backend is not available. Please install &quot;</span>
                <span class="s2">&quot;&#39;jiminy[meshcat]&#39;.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown backend &#39;</span><span class="si">{</span><span class="n">backend_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to provide cross-platform time sleep with maximum accuracy.</span>

<span class="sd">        .. note::</span>
<span class="sd">            It returns immediately instead of raising an exception if the</span>
<span class="sd">            input time is negative.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Wrapper around the standard method &#39;time.sleep&#39; which provides</span>
<span class="sd">            high-precision cross-platform sleep method since Python&gt;=3.11.</span>

<span class="sd">        :param dt: Sleep duration in seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Early return if already too late</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Timer jitter estimate</span>
    <span class="n">TIMER_JITTER</span> <span class="o">=</span> <span class="mf">1e-2</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1e-3</span>

<div class="viewcode-block" id="sleep">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.sleep">[docs]</a>
    <span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to provide cross-platform time sleep with maximum accuracy.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Use this method with cautious since it relies on busy looping</span>
<span class="sd">            principle instead of system scheduler. As a result, it wastes a lot</span>
<span class="sd">            more resources than time.sleep. However, it is the only way to</span>
<span class="sd">            ensure accurate delay on Python&lt;3.11</span>

<span class="sd">        :param dt: Sleep duration in seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Combine busy loop and timer to release the GIL periodically</span>
        <span class="n">t_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">+</span> <span class="n">dt</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t_end</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">TIMER_JITTER</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">get_color_code</span><span class="p">(</span>
        <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple4FType</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple4FType</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sanitize color codes.</span>

<span class="sd">    All it does is converting color codes that has been specified through</span>
<span class="sd">    pre-defined names into their corresponding 4-tuple (R, G, B, A), where each</span>
<span class="sd">    component is a floating-point scalar normalized in range [0.0, 1.0].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">COLORS</span><span class="p">[</span><span class="n">color</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">colors_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Color &#39;</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">&#39; not available. Use a custom (R,G,B,A) &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;code, or a predefined named color (</span><span class="si">{</span><span class="n">colors_str</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">return</span> <span class="n">color</span>


<span class="k">def</span> <span class="nf">_must_be_open</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fun_safe</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Viewer</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Viewer</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Viewer</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Viewer</span><span class="p">):</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;No backend available. Please start one before calling &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fun_safe</span>


<span class="k">def</span> <span class="nf">_with_lock</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fun_safe</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Viewer</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Viewer</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Viewer</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Viewer</span><span class="p">):</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fun_safe</span>


<span class="k">def</span> <span class="nf">_is_async</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fun_safe</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;panda3d&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">with</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">async_mode</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fun_safe</span>


<span class="k">class</span> <span class="nc">_ProcessWrapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrap `multiprocessing.Process`, `subprocess.Popen`, and `psutil.Process`</span>
<span class="sd">    and `Panda3dApp` in the same object to provide unified API.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">proc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
                     <span class="n">ProcessMP</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Panda3dApp</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="n">proc</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Automatically kill process at garbage collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the wrapped process is a child of the main python process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">,</span> <span class="n">Process</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the wrapped process is running or idle, but not terminated</span>
<span class="sd">        nor a zombie yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">,</span> <span class="n">ProcessMP</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">,</span> <span class="n">Process</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">psutil</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">status</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="n">psutil</span><span class="o">.</span><span class="n">STATUS_RUNNING</span><span class="p">,</span> <span class="n">psutil</span><span class="o">.</span><span class="n">STATUS_SLEEPING</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># if isinstance(self._proc, Panda3dApp):</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait until the wrapped process finish what its current task or</span>
<span class="sd">        timeout is reached.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">,</span> <span class="n">ProcessMP</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">,</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="n">Process</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">,</span> <span class="n">Panda3dApp</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If wrapped process if it is a child of the main python process and</span>
<span class="sd">        it is still alive that the time being.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_parent</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">,</span> <span class="n">Panda3dApp</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Try to terminate cleanly</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">,</span>
                        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">):</span>
                    <span class="k">pass</span>

                <span class="c1"># Force kill if necessary and reap the zombies</span>
                <span class="kn">import</span> <span class="nn">psutil</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Assert(s) for type checker</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                    <span class="n">Process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">,</span>
                        <span class="ne">ChildProcessError</span><span class="p">,</span>
                        <span class="ne">PermissionError</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="n">multiprocessing</span><span class="o">.</span><span class="n">active_children</span><span class="p">()</span>


<span class="n">CameraPoseType</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span>


<span class="k">class</span> <span class="nc">CameraMotionBreakpointType</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Basic data structure storing all the information needed to describe a</span>
<span class="sd">    camera motion breakpoint, ie the expected pose of the camera at a given</span>
<span class="sd">    point in time.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">t</span><span class="p">:</span> <span class="nb">float</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Time at which the camera is expected to have in a specific pose.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pose</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">,</span> <span class="n">Tuple3FType</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exacted absolute pose of the camera, as a tuple position (X, Y, Z),</span>
<span class="sd">    rotation (Roll, Pitch, Yaw).</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="n">CameraMotionType</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">CameraMotionBreakpointType</span><span class="p">]</span>

<span class="n">Matrix3FType</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># No easy way to specified fixed-size 2-dim array</span>
<span class="n">RotationType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple4FType</span><span class="p">,</span> <span class="n">Matrix3FType</span><span class="p">]</span>
<span class="n">FramePoseType</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">,</span> <span class="n">RotationType</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">MarkerDataType</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pose of the marker, as a single vector (position [X, Y, Z] + rotation</span>
<span class="sd">    [Quat X, Quat Y, Quat Z, Quat W]).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Size of the marker. Each principal axis of the geometry are scaled</span>
<span class="sd">    separately.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scale</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Tuple3FType</span><span class="p">]]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Color of the marker, as a list of 4 floating-point values ranging from</span>
<span class="sd">    0.0 to 1.0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple4FType</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Tuple4FType</span><span class="p">]]]</span>


<div class="viewcode-block" id="Viewer">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer">[docs]</a>
<span class="k">class</span> <span class="nc">Viewer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Backend-agnostic 3D viewer.</span>

<span class="sd">    This class can be used to render the state of a robot, including sensor</span>
<span class="sd">    data and external forces if any. It is mainly used to render the current</span>
<span class="sd">    simulation state or replay multiple complete trajectories as-posteriori.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The environment variable &#39;JIMINY_INTERACTIVE_DISABLE&#39; can be</span>
<span class="sd">        used to force disabling interactive display.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The environment variable &#39;JIMINY_VIEWER_DEFAULT_BACKEND&#39; can be</span>
<span class="sd">        used to overwrite the default backend.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">window_name</span> <span class="o">=</span> <span class="s1">&#39;jiminy&#39;</span>
    <span class="n">_has_gui</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_backend_obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Panda3dApp</span><span class="p">,</span>
                                 <span class="n">Panda3dViewer</span><span class="p">,</span>
                                 <span class="s2">&quot;Panda3dQWidget&quot;</span><span class="p">,</span>  <span class="c1"># noqa: F821</span>
                                 <span class="s2">&quot;MeshcatWrapper&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># noqa: F821</span>
    <span class="n">_backend_proc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ProcessWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_backend_robot_names</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">_backend_robot_colors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple4FType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_camera_motion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">,</span> <span class="n">Tuple3FType</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_camera_travelling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_camera_xyzrpy</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">,</span> <span class="n">Tuple3FType</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_CAMERA_XYZRPY_ABS</span>
    <span class="n">_lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>  <span class="c1"># Unique lock for every viewer in same thread by default</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># pylint: disable=unused-argument</span>
                 <span class="n">robot</span><span class="p">:</span> <span class="n">jiminy</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
                 <span class="n">use_theoretical_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">robot_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple4FType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">lock</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RLock</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">open_gui_if_parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">delete_robot_on_close</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">robot_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">scene_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;world&#39;</span><span class="p">,</span>
                 <span class="n">display_com</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">display_dcm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">display_contact_frames</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">display_contact_forces</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">display_f_external</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
                     <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param robot: Jiminy.Model to display.</span>
<span class="sd">        :param use_theoretical_model: Whether to use the theoretical rigid or</span>
<span class="sd">                                      extended simulation model of this robot.</span>
<span class="sd">                                      Note that using the extended model if</span>
<span class="sd">                                      possible is more efficient since update</span>
<span class="sd">                                      of the frames placements can be skipped</span>
<span class="sd">                                      as it is already synchronized with the</span>
<span class="sd">                                      simulation state.</span>
<span class="sd">                                      Optional: Actual model by default.</span>
<span class="sd">        :param robot_color: Color of the robot. It will override the original</span>
<span class="sd">                            color of the meshes if not `None`. It supports both</span>
<span class="sd">                            RGBA codes as a list of 4 floating-point values</span>
<span class="sd">                            ranging from 0.0 and 1.0, and a few named colors.</span>
<span class="sd">                            Optional: Disabled by default.</span>
<span class="sd">        :param lock: Custom threading.RLock for parallel rendering. `None` to</span>
<span class="sd">                     use the unique lock associated with the current thread.</span>
<span class="sd">                     Optional: `None` by default.</span>
<span class="sd">        :param backend: Name of the rendering backend to use. It can be either</span>
<span class="sd">                        &#39;panda3d&#39;, &#39;panda3d-qt&#39;, &#39;meshcat&#39;. None to keep using</span>
<span class="sd">                        to one already running if any, or the default one</span>
<span class="sd">                        otherwise. Note that the default is hardware and</span>
<span class="sd">                        environment dependent. See `viewer.default_backend`</span>
<span class="sd">                        method for details.</span>
<span class="sd">                        Optional: `None` by default.</span>
<span class="sd">        :param open_gui_if_parent: Open GUI if new viewer&#39;s backend server is</span>
<span class="sd">                                   started. `None` to fallback to default.</span>
<span class="sd">                                   Optional: Do not open gui for &#39;meshcat&#39;</span>
<span class="sd">                                   backend in interactive mode with already one</span>
<span class="sd">                                   display cell already opened, open gui by</span>
<span class="sd">                                   default in any other case if graphical</span>
<span class="sd">                                   server is available.</span>
<span class="sd">        :param delete_robot_on_close: Enable automatic deletion of the robot</span>
<span class="sd">                                      when closing.</span>
<span class="sd">                                      Optional: False by default.</span>
<span class="sd">        :param robot_name: Unique robot name, to identify each robot.</span>
<span class="sd">                           Optional: Randomly generated identifier by default.</span>
<span class="sd">        :param scene_name: Scene name.</span>
<span class="sd">                           Optional: &#39;world&#39; by default.</span>
<span class="sd">        :param display_com: Whether to display the center of mass.</span>
<span class="sd">                            Optional: Disabled by default.</span>
<span class="sd">        :param display_dcm: Whether to display the capture point / DCM.</span>
<span class="sd">                            Optional: Disabled by default.</span>
<span class="sd">        :param display_contact_frames: Whether to display the contact frames.</span>
<span class="sd">                                       Optional: Disabled by default.</span>
<span class="sd">        :param display_contact_forces:</span>
<span class="sd">            Whether to display the contact forces. Note that the user is</span>
<span class="sd">            responsible for updating sensors data since `Viewer.display` is</span>
<span class="sd">            only computing kinematic quantities.</span>
<span class="sd">            Optional: Disabled by default.</span>
<span class="sd">        :param display_f_external:</span>
<span class="sd">            Whether to display the external external forces applied at the</span>
<span class="sd">            joints on the robot. If a boolean is provided, the same visibility</span>
<span class="sd">            will be set for each joint, alternatively one can provide a boolean</span>
<span class="sd">            list whose ordering is consistent with `pinocchio_model.names`.</span>
<span class="sd">            Note that the user is responsible for updating the force buffer</span>
<span class="sd">            `viewer.f_external` data since `Viewer.display` is only computing</span>
<span class="sd">            kinematic quantities.</span>
<span class="sd">            Optional: Root joint for robot with freeflyer by default.</span>
<span class="sd">        :param kwargs: Unused extra keyword arguments to enable forwarding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define some attribute to avoid raising exception at exit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
            <span class="s2">&quot;undefined&quot;</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">_get_candidate_names</span><span class="p">())))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_open</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Make sure the robot is properly initialized</span>
        <span class="k">assert</span> <span class="n">robot</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Robot not initialized. Impossible to instantiate a viewer.&quot;</span><span class="p">)</span>

        <span class="c1"># Handling of default arguments</span>
        <span class="k">if</span> <span class="n">robot_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">uniq_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">_get_candidate_names</span><span class="p">())</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">robot</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">robot</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;robot&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">robot_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">base_name</span><span class="p">,</span> <span class="n">uniq_id</span><span class="p">))</span>

        <span class="c1"># Pick the default backend if unspecified and none is already selected</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">backend</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">backend</span> <span class="o">=</span> <span class="n">get_default_backend</span><span class="p">()</span>

        <span class="c1"># Make sure that the windows, scene and robot names are valid</span>
        <span class="k">if</span> <span class="n">scene_name</span> <span class="o">==</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">window_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The name of the scene and window must be different.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[A-Za-z0-9_]+$&#39;</span><span class="p">,</span> <span class="n">scene_name</span> <span class="o">+</span> <span class="n">robot_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Scene and robot names restricted to case-insensitive ASCII &quot;</span>
                <span class="s2">&quot;alphanumeric characters plus underscore.&quot;</span><span class="p">)</span>

        <span class="c1"># Robot names must be unique, then backup the desired one</span>
        <span class="k">if</span> <span class="n">robot_name</span> <span class="ow">in</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Robot name already exists but must be unique. Please choose &quot;</span>
                <span class="s2">&quot;a different one, or close the associated viewer.&quot;</span><span class="p">)</span>

        <span class="c1"># Enforce some arguments based on available features</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">display_com</span> <span class="ow">or</span> <span class="n">display_dcm</span> <span class="ow">or</span> <span class="n">display_contact_frames</span> <span class="ow">or</span> \
                    <span class="n">display_contact_forces</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Panda3d backend is required to display markers, e.g. &quot;</span>
                    <span class="s2">&quot;CoM, DCM or Contact.&quot;</span><span class="p">)</span>
            <span class="n">display_com</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">display_dcm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">display_contact_frames</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">display_contact_forces</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Backup some user arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_color</span> <span class="o">=</span> <span class="n">get_color_code</span><span class="p">(</span><span class="n">robot_color</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span> <span class="o">=</span> <span class="n">robot_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scene_name</span> <span class="o">=</span> <span class="n">scene_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_theoretical_model</span> <span class="o">=</span> <span class="n">use_theoretical_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_robot_on_close</span> <span class="o">=</span> <span class="n">delete_robot_on_close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">lock</span> <span class="ow">or</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_com</span> <span class="o">=</span> <span class="n">display_com</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_dcm</span> <span class="o">=</span> <span class="n">display_dcm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_contact_frames</span> <span class="o">=</span> <span class="n">display_contact_frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_contact_forces</span> <span class="o">=</span> <span class="n">display_contact_forces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_f_external</span> <span class="o">=</span> <span class="n">display_f_external</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_open</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Initialize marker register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MarkerDataType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scene_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">,</span> <span class="s2">&quot;markers&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_markers_visibility</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Initialize external forces</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_theoretical_model</span><span class="p">:</span>
            <span class="n">njoints</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">pinocchio_model_th</span><span class="o">.</span><span class="n">njoints</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">njoints</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">njoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_external</span> <span class="o">=</span> <span class="n">pin</span><span class="o">.</span><span class="n">StdVec_Force</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_external</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">pin</span><span class="o">.</span><span class="n">Force</span><span class="o">.</span><span class="n">Zero</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>

        <span class="c1"># Create a unique temporary directory, specific to this viewer instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span>
            <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">Viewer</span><span class="o">.</span><span class="n">window_name</span><span class="p">,</span> <span class="n">scene_name</span><span class="p">,</span> <span class="n">robot_name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>

        <span class="c1"># Access the current backend or create one if none is available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_backend_parent</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Start viewer backend</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">connect_backend</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>

            <span class="c1"># Assert(s) for type checker</span>
            <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="c1"># Decide whether to open gui</span>
            <span class="k">if</span> <span class="n">open_gui_if_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_display_available</span><span class="p">():</span>
                    <span class="n">open_gui_if_parent</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;meshcat&#39;</span><span class="p">:</span>
                    <span class="c1"># Opening a new display cell automatically if there is</span>
                    <span class="c1"># no other display cell already opened.</span>
                    <span class="n">open_gui_if_parent</span> <span class="o">=</span> <span class="n">interactive_mode</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                        <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">comm_manager</span><span class="o">.</span><span class="n">n_comm</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;panda3d&#39;</span><span class="p">:</span>
                    <span class="n">open_gui_if_parent</span> <span class="o">=</span> <span class="n">interactive_mode</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">open_gui_if_parent</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Keep track of the backend process associated to the viewer.</span>
            <span class="c1"># The destructor of this instance must adapt its behavior to the</span>
            <span class="c1"># case where the backend process has changed in the meantime.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backend_proc</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_proc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__is_open</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Open gui if requested</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">open_gui_if_parent</span><span class="p">:</span>
                    <span class="n">Viewer</span><span class="o">.</span><span class="n">open_gui</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Convert exception into warning if it fails. It is probably</span>
                <span class="c1"># because no display is available.</span>
                <span class="n">traceback</span> <span class="o">=</span> <span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format</span><span class="p">()))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Impossible to create backend or connect to it.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># Load the robot</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">robot_name</span><span class="p">)</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="p">[</span><span class="n">robot_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_color</span><span class="p">)</span>

        <span class="c1"># Set default camera pose</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_backend_parent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_camera_transform</span><span class="p">()</span>

        <span class="c1"># Refresh the viewer since the positions of the meshes and their</span>
        <span class="c1"># visibility mode are not properly set at this point.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span>
            <span class="n">force_update_visual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_update_collision</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Automatically close the viewer at garbage collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">robot</span><span class="p">:</span> <span class="n">jiminy</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
               <span class="n">robot_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple4FType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load (or reload) robot in viewer.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This method must be called after calling `engine.reset` since at</span>
<span class="sd">            this point the viewer has dangling references to the collision</span>
<span class="sd">            model and data of robot. Indeed, a new robot is generated at each</span>
<span class="sd">            reset to add some stochasticity to the mass distribution and some</span>
<span class="sd">            other parameters. This is done automatically if  one is using</span>
<span class="sd">            `simulator.Simulator` instead of `jiminy_py.core.Engine` directly.</span>

<span class="sd">        :param robot: jiminy.Model to display.</span>
<span class="sd">        :param robot_color: Color of the robot. It will override the original</span>
<span class="sd">                            color of the meshes if not `None`. It supports both</span>
<span class="sd">                            RGBA codes as a list of 4 floating-point values</span>
<span class="sd">                            ranging from 0.0 and 1.0, and a few named colors.</span>
<span class="sd">                            Optional: Disabled by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Delete existing robot, if any</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span> <span class="ow">in</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_names</span>
        <span class="n">robot_node_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">scene_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">))</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_delete_nodes_viewer</span><span class="p">([</span>
            <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">robot_node_path</span><span class="p">,</span> <span class="s2">&quot;visuals&quot;</span><span class="p">)),</span>
            <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">robot_node_path</span><span class="p">,</span> <span class="s2">&quot;collisions&quot;</span><span class="p">))])</span>

        <span class="c1"># Backup desired color</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span> <span class="ow">in</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_color</span> <span class="o">=</span> <span class="n">get_color_code</span><span class="p">(</span><span class="n">robot_color</span><span class="p">)</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_color</span>

        <span class="c1"># Create backend wrapper to get (almost) backend-independent API.</span>
        <span class="n">backend_type</span> <span class="o">=</span> <span class="n">get_backend_type</span><span class="p">(</span><span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_theoretical_model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">backend_type</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">pinocchio_model_th</span><span class="p">,</span>
                                        <span class="n">robot</span><span class="o">.</span><span class="n">collision_model_th</span><span class="p">,</span>
                                        <span class="n">robot</span><span class="o">.</span><span class="n">visual_model_th</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The viewer is sharing memory with the engine. It avoids having to</span>
            <span class="c1"># keep track of the current state of the system and to update the</span>
            <span class="c1"># internal state for the viewer accordingly every time it changes.</span>
            <span class="c1"># It spares computational resources by avoiding computing twice the</span>
            <span class="c1"># same quantities and it enables to display quantities that cannot</span>
            <span class="c1"># be recovered from the current state only, eg the contact forces.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">backend_type</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="p">,</span>
                                        <span class="n">robot</span><span class="o">.</span><span class="n">collision_model</span><span class="p">,</span>
                                        <span class="n">robot</span><span class="o">.</span><span class="n">visual_model</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">pinocchio_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">visual_data</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">visual_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">collision_data</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">collision_data</span>

        <span class="c1"># Reset external force buffer iif it is necessary</span>
        <span class="n">njoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">njoints</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_external</span><span class="p">)</span> <span class="o">!=</span> <span class="n">njoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_external</span> <span class="o">=</span> <span class="n">pin</span><span class="o">.</span><span class="n">StdVec_Force</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_external</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">pin</span><span class="o">.</span><span class="n">Force</span><span class="o">.</span><span class="n">Zero</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>

        <span class="c1"># Initialize the viewer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">initViewer</span><span class="p">(</span><span class="n">viewer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="p">,</span> <span class="n">loadModel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Create the scene and load robot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">loadViewerModel</span><span class="p">(</span>
            <span class="n">root_node_name</span><span class="o">=</span><span class="n">robot_node_path</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_color</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="c1"># Add markers&#39; display groups</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">append_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">remove_if_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Extract data for fast access</span>
            <span class="n">com_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">com</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">com_velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vcom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">gravity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">gravity</span><span class="o">.</span><span class="n">linear</span>
            <span class="n">dcm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Add center of mass</span>
            <span class="k">def</span> <span class="nf">get_com_scale</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Tuple3FType</span><span class="p">:</span>
                <span class="k">nonlocal</span> <span class="n">com_position</span>
                <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">com_position</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;COM_0_sphere&quot;</span><span class="p">,</span>
                            <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;sphere&quot;</span><span class="p">,</span>
                            <span class="n">pose</span><span class="o">=</span><span class="p">[</span><span class="n">com_position</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                            <span class="n">remove_if_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">auto_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">radius</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;COM_0_cylinder&quot;</span><span class="p">,</span>
                            <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;cylinder&quot;</span><span class="p">,</span>
                            <span class="n">pose</span><span class="o">=</span><span class="p">[</span><span class="n">com_position</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                            <span class="n">scale</span><span class="o">=</span><span class="n">get_com_scale</span><span class="p">,</span>
                            <span class="n">remove_if_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">auto_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">radius</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span>
                            <span class="n">length</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">anchor_bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">display_center_of_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_com</span><span class="p">)</span>

            <span class="c1"># Add DCM marker</span>
            <span class="k">def</span> <span class="nf">get_dcm_pose</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FramePoseType</span><span class="p">:</span>
                <span class="k">nonlocal</span> <span class="n">com_position</span><span class="p">,</span> <span class="n">com_velocity</span><span class="p">,</span> <span class="n">gravity</span><span class="p">,</span> <span class="n">dcm</span>
                <span class="k">if</span> <span class="n">com_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">omega</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">gravity</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">com_position</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">dcm</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">com_position</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">com_velocity</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">omega</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">dcm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]))</span>

            <span class="k">def</span> <span class="nf">get_dcm_scale</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Tuple3FType</span><span class="p">:</span>
                <span class="k">nonlocal</span> <span class="n">com_position</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,),</span> <span class="n">com_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;DCM&quot;</span><span class="p">,</span>
                            <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;cone&quot;</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
                            <span class="n">pose</span><span class="o">=</span><span class="n">get_dcm_pose</span><span class="p">,</span>
                            <span class="n">scale</span><span class="o">=</span><span class="n">get_dcm_scale</span><span class="p">,</span>
                            <span class="n">remove_if_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">auto_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">radius</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
                            <span class="n">length</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
                            <span class="n">num_sides</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">display_capture_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_dcm</span><span class="p">)</span>

            <span class="c1"># Add contact frame markers</span>
            <span class="k">for</span> <span class="n">frame_name</span><span class="p">,</span> <span class="n">frame_index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">robot</span><span class="o">.</span><span class="n">contact_frame_names</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">contact_frame_indices</span><span class="p">):</span>
                <span class="n">frame_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">oMf</span><span class="p">[</span><span class="n">frame_index</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s2">&quot;ContactFrame&quot;</span><span class="p">,</span> <span class="n">frame_name</span><span class="p">)),</span>
                                <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;sphere&quot;</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
                                <span class="n">pose</span><span class="o">=</span><span class="p">[</span><span class="n">frame_pose</span><span class="o">.</span><span class="n">translation</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                                <span class="n">remove_if_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">auto_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">radius</span><span class="o">=</span><span class="mf">0.006</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">display_contact_frames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_contact_frames</span><span class="p">)</span>

            <span class="c1"># Add contact sensor markers</span>
            <span class="k">def</span> <span class="nf">get_contact_scale</span><span class="p">(</span><span class="n">sensor_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple3FType</span><span class="p">:</span>
                <span class="n">f_z_rel</span> <span class="o">=</span> <span class="n">sensor_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">CONTACT_FORCE_SCALE</span>
                <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">f_z_rel</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">robot</span><span class="o">.</span><span class="n">sensors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ContactSensor</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">frame_index</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">.</span><span class="n">frame_index</span><span class="p">,</span> <span class="n">sensor</span><span class="o">.</span><span class="n">data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">sensor</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">sensor</span><span class="o">.</span><span class="n">name</span><span class="p">)),</span>
                                <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;cylinder&quot;</span><span class="p">,</span>
                                <span class="n">pose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">oMf</span><span class="p">[</span><span class="n">frame_index</span><span class="p">],</span>
                                <span class="n">scale</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_contact_scale</span><span class="p">,</span> <span class="n">data</span><span class="p">),</span>
                                <span class="n">remove_if_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">auto_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">radius</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                                <span class="n">length</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                <span class="n">anchor_bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">display_contact_forces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_contact_forces</span><span class="p">)</span>

            <span class="c1"># Add external forces</span>
            <span class="k">def</span> <span class="nf">get_force_pose</span><span class="p">(</span><span class="n">joint_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                               <span class="n">joint_position</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                               <span class="n">joint_rotation</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                               <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FramePoseType</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_external</span><span class="p">[</span><span class="n">joint_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">linear</span>
                <span class="n">f_rotation_local</span> <span class="o">=</span> <span class="n">pin</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">f_rotation_world</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">pin</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">(</span><span class="n">joint_rotation</span><span class="p">)</span> <span class="o">*</span> <span class="n">f_rotation_local</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">joint_position</span><span class="p">,</span> <span class="n">f_rotation_world</span><span class="o">.</span><span class="n">coeffs</span><span class="p">())</span>

            <span class="k">def</span> <span class="nf">get_force_scale</span><span class="p">(</span><span class="n">joint_index</span><span class="p">:</span> <span class="nb">int</span>
                                <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
                <span class="n">f_ext</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_external</span><span class="p">[</span><span class="n">joint_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">linear</span>
                <span class="n">f_ext_norm</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">f_ext</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">f_ext_norm</span> <span class="o">/</span> <span class="n">EXTERNAL_FORCE_SCALE</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">joint_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">joint_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getJointId</span><span class="p">(</span><span class="n">joint_name</span><span class="p">)</span>
                <span class="n">joint_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">oMi</span><span class="p">[</span><span class="n">joint_index</span><span class="p">]</span>
                <span class="n">pose_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">get_force_pose</span><span class="p">,</span>
                                  <span class="n">joint_index</span><span class="p">,</span>
                                  <span class="n">joint_pose</span><span class="o">.</span><span class="n">translation</span><span class="p">,</span>
                                  <span class="n">joint_pose</span><span class="o">.</span><span class="n">rotation</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ForceExternal_</span><span class="si">{</span><span class="n">joint_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;arrow&quot;</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                                <span class="n">pose</span><span class="o">=</span><span class="n">pose_fn</span><span class="p">,</span>
                                <span class="n">scale</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_force_scale</span><span class="p">,</span> <span class="n">joint_index</span><span class="p">),</span>
                                <span class="n">remove_if_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">auto_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">anchor_top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">radius</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span>
                                <span class="n">length</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

            <span class="c1"># Check if external forces visibility is deprecated</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_f_external</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_f_external</span><span class="p">)</span> <span class="o">!=</span> <span class="n">njoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_display_f_external</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Display external forces only on freeflyer by default</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_f_external</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_display_f_external</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="n">robot</span><span class="o">.</span><span class="n">has_freeflyer</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">njoints</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">display_external_forces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_f_external</span><span class="p">)</span>

<div class="viewcode-block" id="Viewer.open_gui">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.open_gui">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">open_gui</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open a new viewer graphical interface. It is only possible if a</span>
<span class="sd">        backend is already running.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Only one graphical interface can be opened locally for efficiency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># If a graphical window is already open, do nothing</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">has_gui</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># Check if a display is available</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_display_available</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;No display available. Impossible to open a gui.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;panda3d-qt&#39;</span><span class="p">,</span> <span class="s1">&#39;panda3d-sync&#39;</span><span class="p">):</span>
            <span class="c1"># No instance is considered manager of the unique window</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Impossible to open gui with &#39;</span><span class="si">{</span><span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="si">}</span><span class="s2">&#39; backend.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;panda3d&#39;</span><span class="p">:</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">open_window</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;meshcat&#39;</span><span class="p">:</span>
            <span class="n">viewer_url</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">url</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">interactive_mode</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># pylint: disable=import-outside-toplevel,no-name-in-module</span>
                <span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>

                <span class="c1"># Scrap the viewer html content, including javascript</span>
                <span class="c1"># dependencies</span>
                <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">viewer_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                    <span class="n">html_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;&lt;script type=&quot;text/javascript&quot; src=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;&lt;/script&gt;&#39;</span>
                <span class="n">scripts_js</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span> <span class="o">%</span> <span class="s1">&#39;(.*)&#39;</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">scripts_js</span><span class="p">:</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">viewer_url</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                        <span class="n">js_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                    <span class="n">html_content</span> <span class="o">=</span> <span class="n">html_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pattern</span> <span class="o">%</span> <span class="n">file</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">js_content</span><span class="si">}</span>
<span class="s2">                    &lt;/script&gt;&quot;&quot;&quot;</span><span class="p">)</span>

                <span class="c1"># Provide websocket URL as fallback if needed. It would be</span>
                <span class="c1"># the case if the environment is not jupyter-notebook nor</span>
                <span class="c1"># colab but rather jupyterlab or vscode for instance.</span>
                <span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">get_ipython</span>
                <span class="n">kernel</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">interactive_mode</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">kernel_config_app</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ColabKernelApp&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kernel_config_app</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;IPKernelApp&#39;</span><span class="p">]</span>
                <span class="n">conn_file</span> <span class="o">=</span> <span class="n">kernel_config_app</span><span class="p">[</span><span class="s1">&#39;connection_file&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">kernel_id</span> <span class="o">=</span> <span class="n">conn_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">kernel_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">kernel_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">parent_proc</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
                    <span class="k">assert</span> <span class="n">parent_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">parent_pid</span> <span class="o">=</span> <span class="n">parent_proc</span><span class="o">.</span><span class="n">pid</span>
                    <span class="n">server_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">notebook</span> <span class="kn">import</span> <span class="n">notebookapp</span>
                        <span class="n">server_list</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">notebookapp</span><span class="o">.</span><span class="n">list_running_servers</span><span class="p">())</span>
                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                        <span class="c1"># `notebook&gt;=7.0` has removed this submodule entirely</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">jupyter_server</span> <span class="kn">import</span> <span class="n">serverapp</span>
                        <span class="n">server_list</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">serverapp</span><span class="o">.</span><span class="n">list_running_servers</span><span class="p">())</span>
                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">for</span> <span class="n">server_cfg</span> <span class="ow">in</span> <span class="n">server_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">server_cfg</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">parent_pid</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">ws_url</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;ws</span><span class="si">{</span><span class="n">server_cfg</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span><span class="si">}</span><span class="s2">api/kernels/</span><span class="si">{</span><span class="n">kernel_id</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;/channels?token=</span><span class="si">{</span><span class="n">server_cfg</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">html_content</span> <span class="o">=</span> <span class="n">html_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s2">&quot;var ws_url = undefined;&quot;</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s1">&#39;var ws_url = &quot;</span><span class="si">{</span><span class="n">ws_url</span><span class="si">}</span><span class="s1">&quot;;&#39;</span><span class="p">)</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="n">interactive_mode</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Isolate HTML in iframe</span>
                    <span class="n">html_content</span> <span class="o">=</span> <span class="n">html_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;apos;&quot;</span><span class="p">)</span>
                    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        &lt;div class=&quot;resizable&quot; style=&quot;</span>
<span class="s2">                                height: 400px; width: 100%;</span>
<span class="s2">                                overflow-x: auto; overflow-y: hidden;</span>
<span class="s2">                                resize: both&quot;&gt;</span>
<span class="s2">                            &lt;iframe srcdoc=&quot;</span><span class="si">{</span><span class="n">html_content</span><span class="si">}</span><span class="s2">&quot; style=&quot;</span>
<span class="s2">                                width: 100%; height: 100%; border: none;&quot;&gt;</span>
<span class="s2">                            &lt;/iframe&gt;</span>
<span class="s2">                        &lt;/div&gt;</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Impossible to isolate HTML to get access to google colab</span>
                    <span class="n">html_content</span> <span class="o">=</span> <span class="n">html_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s1">&#39;&lt;div id=&quot;meshcat-pane&quot;&gt;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        &lt;div id=&quot;meshcat-pane&quot; class=&quot;resizable&quot; style=&quot;</span>
<span class="s2">                                height: 400px; width: 100%;</span>
<span class="s2">                                overflow-x: auto; overflow-y: hidden;</span>
<span class="s2">                                resize: both&quot;&gt;</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">)</span>

                    <span class="c1"># Make meshcat dom element unique to avoid conflict if</span>
                    <span class="c1"># multiple view are displayed.</span>
                    <span class="n">html_content</span> <span class="o">=</span> <span class="n">html_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;meshcat-pane&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()))</span>

                    <span class="c1"># Display the content directly inside the main window</span>
                    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">html_content</span><span class="p">))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">has_gui</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">webbrowser</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">viewer_url</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">autoraise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">webbrowser</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>  <span class="c1"># Fail if not browser is available</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;No browser available for display. Please install one &quot;</span>
                        <span class="s2">&quot;manually.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>  <span class="c1"># Skip waiting since there is nothing to wait for</span>

        <span class="c1"># Wait to finish loading</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">require_client</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># There is at least one graphical window at this point</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_has_gui</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Viewer.has_gui">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.has_gui">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">has_gui</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the viewer has a Graphical User Interface (GUI), ie the</span>
<span class="sd">        viewer is connected to a given backend that is running up to now, and</span>
<span class="sd">        onscreen rendering has been specifically requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="c1"># Assert(s) for type checker</span>
            <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="c1"># Make sure the viewer still has gui if necessary</span>
            <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;meshcat&#39;</span><span class="p">:</span>
                <span class="n">ack</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">require_client</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Viewer</span><span class="o">.</span><span class="n">_has_gui</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">ack</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_has_gui</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Viewer.wait">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.wait">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="n">require_client</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for all the meshes to finish loading in every clients.</span>

<span class="sd">        :param require_client: Wait for at least one client to be available</span>
<span class="sd">                               before checking for mesh loading.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;meshcat&#39;</span><span class="p">:</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">require_client</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">step</span><span class="p">()</span></div>


<div class="viewcode-block" id="Viewer.is_alive">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.is_alive">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_alive</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the backend server is running and responding to queries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span></div>


<div class="viewcode-block" id="Viewer.is_open">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.is_open">[docs]</a>
    <span class="k">def</span> <span class="nf">is_open</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Viewer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a given viewer instance is open, or if the backend server</span>
<span class="sd">        is running if no instance is specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_open_</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_open_</span> <span class="o">=</span> <span class="n">is_open_</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_open</span>
        <span class="k">return</span> <span class="n">is_open_</span></div>


<div class="viewcode-block" id="Viewer.close">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.close">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Viewer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close a given viewer instance, or all of them if no instance is</span>
<span class="sd">        specified.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Calling this method with an viewer instance always closes the</span>
<span class="sd">            client. It may also remove the robot from the server if the viewer</span>
<span class="sd">            attribute `delete_robot_on_close` is True. Moreover, it is the one</span>
<span class="sd">            having started the backend server, it also terminates it, resulting</span>
<span class="sd">            in closing every viewer somehow. It results in the same outcome</span>
<span class="sd">            than calling this method without specifying any viewer instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=unsubscriptable-object</span>

        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># NEVER closing backend automatically if closing instances,</span>
            <span class="c1"># even for the parent. It will be closed at Python exit</span>
            <span class="c1"># automatically. One must call `Viewer.close` to do otherwise.</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_names</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_xyzrpy</span> <span class="o">=</span> <span class="n">DEFAULT_CAMERA_XYZRPY_ABS</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">detach_camera</span><span class="p">()</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">remove_camera_motion</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="c1"># Assert(s) for type checker</span>
                <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;meshcat&#39;</span><span class="p">:</span>
                    <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">ViewerClosedError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_proc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_has_gui</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Consider that the robot is not available anymore, no matter what</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_names</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">)</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Disable travelling if associated with this viewer instance</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_travelling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_travelling</span><span class="p">[</span><span class="s1">&#39;viewer&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">):</span>
                <span class="n">Viewer</span><span class="o">.</span><span class="n">detach_camera</span><span class="p">()</span>

            <span class="c1"># Check if the backend process has changed or the viewer instance</span>
            <span class="c1"># has already been closed, which may happened if it has been closed</span>
            <span class="c1"># manually in the meantime. If so, there is nothing left to do.</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_open</span> <span class="ow">or</span>
                    <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend_proc</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="c1"># Assert(s) for type checker</span>
            <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="c1"># Make sure zmq does not hang</span>
            <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;meshcat&#39;</span> <span class="ow">and</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">zmq_socket</span><span class="o">.</span><span class="n">RCVTIMEO</span> <span class="o">=</span> <span class="mi">200</span>

            <span class="c1"># Delete robot from scene if requested</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_robot_on_close</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span><span class="p">()):</span>  <span class="c1"># type: ignore[unreachable]</span>
                <span class="k">try</span><span class="p">:</span>  <span class="c1"># type: ignore[unreachable]</span>
                    <span class="n">Viewer</span><span class="o">.</span><span class="n">_delete_nodes_viewer</span><span class="p">([</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">visual_group</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">collision_group</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">])</span>
                <span class="k">except</span> <span class="n">ViewerError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c1"># Restore zmq socket timeout, which is disable by default</span>
            <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;meshcat&#39;</span><span class="p">:</span>
                <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">zmq_socket</span><span class="o">.</span><span class="n">RCVTIMEO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c1"># Delete temporary directory</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tempdir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tempdir</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c1"># At this point, consider the viewer has been closed no matter what</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__is_open</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Viewer.connect_backend">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.connect_backend">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="k">def</span> <span class="nf">connect_backend</span><span class="p">(</span><span class="n">backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the running process of backend client.</span>

<span class="sd">        This method can be used to open a new process if necessary.</span>

<span class="sd">        :param backend: Name of the rendering backend to use. It can be either</span>
<span class="sd">                        &#39;panda3d&#39;, &#39;panda3d-qt&#39;, &#39;meshcat&#39;.</span>
<span class="sd">                        Optional: The default is hardware and environment</span>
<span class="sd">                        dependent. See `viewer.default_backend` for details.</span>

<span class="sd">        :returns: Pointer to the running backend Client and its PID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=import-outside-toplevel</span>
        <span class="c1"># Handle default arguments</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">backend</span> <span class="o">=</span> <span class="n">get_default_backend</span><span class="p">()</span>

        <span class="c1"># Sanitize user arguments and check requested backend is available</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">get_backend_type</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>

        <span class="c1"># Update the backend currently running, if any</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="n">backend</span> <span class="ow">and</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Different backend already running. Closing it...&quot;</span><span class="p">)</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Nothing to do if already connected</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># Reset some class attribute if backend not available</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">client</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Panda3dApp</span><span class="p">,</span>
                      <span class="n">Panda3dViewer</span><span class="p">,</span>
                      <span class="s2">&quot;Panda3dQWidget&quot;</span><span class="p">,</span>  <span class="c1"># noqa: F821</span>
                      <span class="s2">&quot;MeshcatWrapper&quot;</span><span class="p">]</span>  <span class="c1"># noqa: F821</span>
        <span class="k">if</span> <span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="c1"># Instantiate client with onscreen rendering capability enabled.</span>
            <span class="c1"># Note that it fallbacks to software rendering if necessary.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;panda3d-qt&#39;</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">.panda3d.panda3d_widget</span> <span class="kn">import</span> <span class="n">Panda3dQWidget</span>
                    <span class="n">client</span> <span class="o">=</span> <span class="n">Panda3dQWidget</span><span class="p">()</span>
                    <span class="n">proc</span> <span class="o">=</span> <span class="n">_ProcessWrapper</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;panda3d-sync&#39;</span><span class="p">:</span>
                    <span class="n">client</span> <span class="o">=</span> <span class="n">Panda3dApp</span><span class="p">()</span>
                    <span class="n">proc</span> <span class="o">=</span> <span class="n">_ProcessWrapper</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">client</span> <span class="o">=</span> <span class="n">Panda3dViewer</span><span class="p">(</span><span class="n">window_type</span><span class="o">=</span><span class="s1">&#39;onscreen&#39;</span><span class="p">,</span>
                                           <span class="n">window_title</span><span class="o">=</span><span class="n">Viewer</span><span class="o">.</span><span class="n">window_name</span><span class="p">)</span>
                    <span class="n">proc</span> <span class="o">=</span> <span class="n">_ProcessWrapper</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Something went wrong. Impossible to instantiate viewer &quot;</span>
                    <span class="s2">&quot;backend.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

            <span class="c1"># The gui is the client itself</span>
            <span class="n">client</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="n">client</span>  <span class="c1"># type: ignore[union-attr]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># List of connections likely to correspond to Meshcat servers</span>
            <span class="kn">import</span> <span class="nn">psutil</span>
            <span class="n">meshcat_candidate_conn</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">pids</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">proc_info</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">proc_info</span><span class="o">.</span><span class="n">net_connections</span><span class="p">(</span><span class="s2">&quot;tcp4&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;LISTEN&#39;</span> <span class="ow">or</span> \
                                <span class="n">conn</span><span class="o">.</span><span class="n">laddr</span><span class="o">.</span><span class="n">ip</span> <span class="o">!=</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">cmdline</span> <span class="o">=</span> <span class="n">proc_info</span><span class="o">.</span><span class="n">cmdline</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">cmdline</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;python&#39;</span> <span class="ow">in</span> <span class="n">cmdline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span>
                                        <span class="s1">&#39;meshcat&#39;</span> <span class="ow">in</span> <span class="n">cmdline</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">meshcat_candidate_conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">AccessDenied</span><span class="p">,</span>
                        <span class="n">psutil</span><span class="o">.</span><span class="n">ZombieProcess</span><span class="p">,</span>
                        <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">):</span>
                    <span class="k">pass</span>

            <span class="c1"># Exclude ipython kernel ports from the look up because sending a</span>
            <span class="c1"># message on ipython ports will throw a low-level exception, that</span>
            <span class="c1"># is not blocking on Jupyter, but is on Google Colab.</span>
            <span class="n">excluded_ports</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">interactive_mode</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">get_ipython</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">excluded_ports</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">_recorded_ports</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">NameError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="k">pass</span>  <span class="c1"># No Ipython kernel running</span>

            <span class="c1"># Use the first port responding to zmq request, if any.</span>
            <span class="c1"># Sorting connections to scan most likely ports first.</span>
            <span class="kn">import</span> <span class="nn">zmq</span>
            <span class="n">zmq_url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">meshcat_candidate_conn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">conn</span><span class="p">:</span> <span class="n">conn</span><span class="o">.</span><span class="n">laddr</span><span class="o">.</span><span class="n">port</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Note that the timeout must be long enough to give enough</span>
                    <span class="c1"># time to the server to respond, but not to long to avoid</span>
                    <span class="c1"># sending to much time spanning the available connections.</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">laddr</span><span class="o">.</span><span class="n">port</span>
                    <span class="k">if</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">excluded_ports</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">zmq_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tcp://127.0.0.1:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">zmq_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
                    <span class="n">zmq_socket</span><span class="o">.</span><span class="n">RCVTIMEO</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># millisecond</span>
                    <span class="n">zmq_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">zmq_url</span><span class="p">)</span>
                    <span class="n">zmq_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">zmq_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">response</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;http&quot;</span><span class="p">:</span>
                        <span class="n">zmq_url</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Again</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ZMQError</span><span class="p">):</span>
                    <span class="n">zmq_url</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">zmq_socket</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">linger</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">zmq_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1"># Create a meshcat server if needed and connect to it</span>
            <span class="kn">from</span> <span class="nn">.meshcat.wrapper</span> <span class="kn">import</span> <span class="n">MeshcatWrapper</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">MeshcatWrapper</span><span class="p">(</span><span class="n">zmq_url</span><span class="p">)</span>
            <span class="n">server_proc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Process</span><span class="p">,</span> <span class="n">ProcessMP</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">server_proc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">server_proc</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">server_proc</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">server_proc</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">_ProcessWrapper</span><span class="p">(</span><span class="n">server_proc</span><span class="p">)</span>

        <span class="c1"># Make sure the backend process is alive</span>
        <span class="k">assert</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">(),</span> <span class="p">(</span>
            <span class="s2">&quot;Something went wrong. Impossible to instantiate viewer backend.&quot;</span><span class="p">)</span>

        <span class="c1"># Update global state</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="o">=</span> <span class="n">client</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_proc</span> <span class="o">=</span> <span class="n">proc</span></div>


    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">_delete_nodes_viewer</span><span class="p">(</span><span class="n">nodes_path</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete an object or a group of objects in the scene.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Be careful, one must specify the full path of a node, including all</span>
<span class="sd">            parent group, but without the window name, ie</span>
<span class="sd">            &#39;scene_name/robot_name&#39; to delete the robot.</span>

<span class="sd">        :param nodes_path: Full path of the node to delete</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">node_path</span> <span class="ow">in</span> <span class="n">nodes_path</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">remove_group</span><span class="p">(</span><span class="n">node_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node_path</span> <span class="ow">in</span> <span class="n">nodes_path</span><span class="p">:</span>
                <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="p">[</span><span class="n">node_path</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

<div class="viewcode-block" id="Viewer.set_watermark">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.set_watermark">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">set_watermark</span><span class="p">(</span><span class="n">img_fullpath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert desired watermark on bottom left corner of the window.</span>

<span class="sd">        .. note::</span>
<span class="sd">            The relative width and height cannot exceed 20% of the visible</span>
<span class="sd">            area, otherwise it will be rescaled.</span>

<span class="sd">        :param img_fullpath: Full path of the image to use as watermark.</span>
<span class="sd">                             Meshcat supports format &#39;.png&#39;, &#39;.jpeg&#39; or &#39;svg&#39;,</span>
<span class="sd">                             while Panda3d only supports &#39;.png&#39; and &#39;.jpeg&#39; for</span>
<span class="sd">                             now. None or empty string to disable.</span>
<span class="sd">                             Optional: None by default.</span>
<span class="sd">        :param width: Desired width for the image. None to not rescale the</span>
<span class="sd">                      image manually.</span>
<span class="sd">                      Optional: None by default.</span>
<span class="sd">        :param height: Desired height for the image. None to not rescale the</span>
<span class="sd">                       image manually.</span>
<span class="sd">                       Optional: None by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">set_watermark</span><span class="p">(</span><span class="n">img_fullpath</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">width</span> <span class="ow">or</span> <span class="n">DEFAULT_WATERMARK_MAXSIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">height</span> <span class="ow">or</span> <span class="n">DEFAULT_WATERMARK_MAXSIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">img_fullpath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">img_fullpath</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">remove_watermark</span><span class="p">()</span></div>


<div class="viewcode-block" id="Viewer.set_legend">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.set_legend">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">set_legend</span><span class="p">(</span><span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert legend on top left corner of the window.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Make sure to have specified different colors for each robot on the</span>
<span class="sd">            scene, since it will be used as marker on the legend.</span>

<span class="sd">        :param labels: Sequence of strings whose length must be consistent</span>
<span class="sd">                       with the number of robots on the scene. None to disable.</span>
<span class="sd">                       Optional: None by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Make sure number of labels is consistent with number of robots</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Inconsistency between robots </span><span class="si">{</span><span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_names</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="si">}</span><span class="s2">) and labels </span><span class="si">{</span><span class="n">labels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure all robots have a specific color</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;All robot must have a specific color when setting a legend.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                    <span class="n">labels</span><span class="p">,</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">set_legend</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">robot_name</span> <span class="ow">in</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">remove_legend_item</span><span class="p">(</span><span class="n">robot_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="n">robot_name</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">labels</span><span class="p">,</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">rgba</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">color</span><span class="p">[:</span><span class="mi">3</span><span class="p">]],</span> <span class="n">color</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">color_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rgba(</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">rgba</span><span class="p">))</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color_text</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
                    <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">set_legend_item</span><span class="p">(</span>
                        <span class="n">robot_name</span><span class="p">,</span> <span class="n">color_text</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></div>


<div class="viewcode-block" id="Viewer.set_clock">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.set_clock">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="nd">@_is_async</span>
    <span class="k">def</span> <span class="nf">set_clock</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert clock on bottom right corner of the window.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Only Panda3d rendering backend is supported by this method.</span>

<span class="sd">        :param t: Current simulation time is seconds. None to disable.</span>
<span class="sd">                  Optional: None by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">set_clock</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Adding clock is only available for Panda3d.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Viewer.get_camera_transform">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.get_camera_transform">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">get_camera_transform</span><span class="p">(</span><span class="n">camera_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">,</span> <span class="n">Tuple3FType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get transform of the camera pose.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            The reference axis is negative z-axis instead of positive x-axis.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            It returns the previous requested camera transform for meshcat,</span>
<span class="sd">            since it is impossible to get access to this information. Thus</span>
<span class="sd">            this method is valid as long as the user does not move the</span>
<span class="sd">            camera manually using mouse camera control.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Specifying a camera name is only supported by Panda3d rendering</span>
<span class="sd">            backend.</span>

<span class="sd">        :param camera_name: Name of the camera to consider. None to specify</span>
<span class="sd">                            the &quot;default&quot; world facing camera that is used</span>
<span class="sd">                            when GUI (onscreen window) in enabled.</span>
<span class="sd">                            Optional: None by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="n">xyz</span><span class="p">,</span> <span class="n">quat</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">get_camera_transform</span><span class="p">()</span>
            <span class="n">quat</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">pin</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">(</span><span class="o">*</span><span class="n">quat</span><span class="p">)</span><span class="o">.</span><span class="n">matrix</span><span class="p">()</span>
            <span class="n">rpy</span> <span class="o">=</span> <span class="n">matrixToRpy</span><span class="p">(</span><span class="n">rot</span> <span class="o">@</span> <span class="n">CAMERA_INV_TRANSFORM_PANDA3D</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">rpy</span>

        <span class="c1"># Make sure that no camera name has been specified for meshcat</span>
        <span class="k">if</span> <span class="n">camera_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Specifying a camera name is only supported by Panda3d.&quot;</span><span class="p">)</span>

        <span class="n">xpy</span><span class="p">,</span> <span class="n">rpy</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_xyzrpy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xpy</span><span class="p">,</span> <span class="n">rpy</span></div>


<div class="viewcode-block" id="Viewer.set_camera_transform">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.set_camera_transform">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">set_camera_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Viewer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">rotation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">relative</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">camera_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set transform of the camera pose.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            The reference axis is negative z-axis instead of positive x-axis,</span>
<span class="sd">            which means that position = [0.0, 0.0, 0.0], rotation =</span>
<span class="sd">            [0.0, 0.0, 0.0] moves the camera at the center of scene, looking</span>
<span class="sd">            downward.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Specifying a camera name is only supported by Panda3d rendering</span>
<span class="sd">            backend.</span>

<span class="sd">        :param position: Position [X, Y, Z] as a list or 1D array. If `None`,</span>
<span class="sd">                         when it will be kept as is.</span>
<span class="sd">                         Optional: None by default.</span>
<span class="sd">        :param rotation: Rotation [Roll, Pitch, Yaw] as a list or 1D np.array.</span>
<span class="sd">                         If `None`, when it will be kept as is.</span>
<span class="sd">                         Optional: None by default.</span>
<span class="sd">        :param relative:</span>
<span class="sd">            .. raw:: html</span>

<span class="sd">                How to apply the transform:</span>

<span class="sd">            - **None:** absolute.</span>
<span class="sd">            - **&#39;camera&#39;:** relative to current camera pose.</span>
<span class="sd">            - **other:** relative to a robot frame, not accounting for the</span>
<span class="sd">              rotation of the frame during travelling. It supports both frame</span>
<span class="sd">              name and index in model.</span>
<span class="sd">        :param camera_name: Name of the camera to consider. None to specify</span>
<span class="sd">                            the &quot;default&quot; world facing camera that is used</span>
<span class="sd">                            when GUI (onscreen window) in enabled.</span>
<span class="sd">                            Optional: None by default.</span>
<span class="sd">        :param wait: Whether to wait for rendering to finish.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=invalid-name, possibly-used-before-assignment</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Viewer</span><span class="p">)</span>

        <span class="c1"># Make sure that no camera name has been specified for meshcat</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;meshcat&#39;</span> <span class="ow">and</span> <span class="n">camera_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Specifying a camera name is only supported by Panda3d.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">relative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">relative</span> <span class="o">!=</span> <span class="s1">&#39;camera&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;A viewer instance must be provided to set camera &quot;</span>
                <span class="s2">&quot;relatively to a frame.&quot;</span><span class="p">)</span>

        <span class="c1"># Handling of position and rotation arguments</span>
        <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rotation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">relative</span> <span class="o">==</span> <span class="s1">&#39;camera&#39;</span><span class="p">:</span>
            <span class="n">position_camera</span><span class="p">,</span> <span class="n">rotation_camera</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">get_camera_transform</span><span class="p">(</span>
                <span class="n">camera_name</span><span class="o">=</span><span class="n">camera_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">relative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">position_camera</span>
        <span class="k">if</span> <span class="n">rotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">relative</span> <span class="o">==</span> <span class="s1">&#39;camera&#39;</span><span class="p">:</span>
                <span class="n">rotation</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation_camera</span>
        <span class="n">position</span><span class="p">,</span> <span class="n">rotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">position</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span>

        <span class="c1"># Compute associated rotation matrix</span>
        <span class="n">rotation_mat</span> <span class="o">=</span> <span class="n">rpyToMatrix</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span>

        <span class="c1"># Compute the relative transformation if necessary</span>
        <span class="k">if</span> <span class="n">relative</span> <span class="o">==</span> <span class="s1">&#39;camera&#39;</span><span class="p">:</span>
            <span class="n">H_orig</span> <span class="o">=</span> <span class="n">SE3</span><span class="p">(</span><span class="n">rpyToMatrix</span><span class="p">(</span><span class="n">rotation_camera</span><span class="p">),</span> <span class="n">position_camera</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">relative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Assert(s) for type checker</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Viewer</span><span class="p">)</span>

            <span class="c1"># Get the body position, not taking into account the rotation</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relative</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getFrameId</span><span class="p">(</span><span class="n">relative</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">oMf</span><span class="p">[</span><span class="n">relative</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;relative&#39; set to non-existing frame.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="n">H_orig</span> <span class="o">=</span> <span class="n">SE3</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">body_transform</span><span class="o">.</span><span class="n">translation</span><span class="p">)</span>

        <span class="c1"># Compute the absolute transformation</span>
        <span class="k">if</span> <span class="n">relative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">H_abs</span> <span class="o">=</span> <span class="n">H_orig</span> <span class="o">*</span> <span class="n">SE3</span><span class="p">(</span><span class="n">rotation_mat</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">H_abs</span><span class="o">.</span><span class="n">translation</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="n">matrixToRpy</span><span class="p">(</span><span class="n">H_abs</span><span class="o">.</span><span class="n">rotation</span><span class="p">)</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">set_camera_transform</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">camera_name</span><span class="o">=</span><span class="n">camera_name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Perform the desired transformation</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="n">rotation_panda3d</span> <span class="o">=</span> <span class="n">pin</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">(</span>
                <span class="n">rotation_mat</span> <span class="o">@</span> <span class="n">CAMERA_INV_TRANSFORM_PANDA3D</span><span class="p">)</span><span class="o">.</span><span class="n">coeffs</span><span class="p">()</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">set_camera_transform</span><span class="p">(</span>
                <span class="n">position</span><span class="p">,</span> <span class="n">rotation_panda3d</span><span class="p">,</span> <span class="n">camera_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;meshcat&#39;</span><span class="p">:</span>
            <span class="c1"># pylint: disable=import-outside-toplevel</span>
            <span class="c1"># Meshcat camera is rotated by -pi/2 along Roll axis wrt the</span>
            <span class="c1"># usual convention in robotics.</span>
            <span class="kn">import</span> <span class="nn">meshcat.transformations</span> <span class="k">as</span> <span class="nn">mtf</span>
            <span class="n">position_meshcat</span> <span class="o">=</span> <span class="n">CAMERA_INV_TRANSFORM_MESHCAT</span> <span class="o">@</span> <span class="n">position</span>
            <span class="n">rotation_meshcat</span> <span class="o">=</span> <span class="n">matrixToRpy</span><span class="p">(</span>
                <span class="n">CAMERA_INV_TRANSFORM_MESHCAT</span> <span class="o">@</span> <span class="n">rotation_mat</span><span class="p">)</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="p">[</span><span class="s2">&quot;/Cameras/default/rotated/&lt;object&gt;&quot;</span><span class="p">]</span><span class="o">.</span>\
                <span class="n">set_transform</span><span class="p">(</span><span class="n">mtf</span><span class="o">.</span><span class="n">compose_matrix</span><span class="p">(</span>
                    <span class="n">translate</span><span class="o">=</span><span class="n">position_meshcat</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="n">rotation_meshcat</span><span class="p">))</span>

        <span class="c1"># Backup updated camera pose</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_xyzrpy</span> <span class="o">=</span> <span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">rotation</span><span class="p">)</span>

        <span class="c1"># Wait for the backend viewer to finish rendering if requested</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">require_client</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="Viewer.set_camera_lookat">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.set_camera_lookat">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">set_camera_lookat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">position</span><span class="p">:</span> <span class="n">Tuple3FType</span><span class="p">,</span>
                          <span class="n">relative</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the camera look-at position.</span>

<span class="sd">        .. note::</span>
<span class="sd">            It preserve the relative camera pose wrt the lookup position.</span>

<span class="sd">        :param position: Position [X, Y, Z] as a list or 1D array</span>
<span class="sd">        :param relative: If specified, set the lookat position relative to</span>
<span class="sd">                         provided position, in absolute world otherwise. Both</span>
<span class="sd">                         frame name and index in model are supported.</span>
<span class="sd">        :param wait: Whether to wait for rendering to finish.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Make sure the backend supports this method</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;This method is only supported by Panda3d.&quot;</span><span class="p">)</span>

        <span class="c1"># Compute absolute lookat position using frame and relative position</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relative</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getFrameId</span><span class="p">(</span><span class="n">relative</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relative</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">body_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">oMf</span><span class="p">[</span><span class="n">relative</span><span class="p">]</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">body_transform</span><span class="o">.</span><span class="n">translation</span> <span class="o">+</span> <span class="n">position</span>

        <span class="c1"># Update camera lookat position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">set_camera_lookat</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>

        <span class="c1"># Wait for the backend viewer to finish rendering if requested</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">require_client</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="Viewer.register_camera_motion">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.register_camera_motion">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">register_camera_motion</span><span class="p">(</span><span class="n">camera_motion</span><span class="p">:</span> <span class="n">CameraMotionType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register camera motion. It will be used later by `replay` to set the</span>
<span class="sd">        absolute or relative camera pose, depending on whether or not</span>
<span class="sd">        travelling is enable.</span>

<span class="sd">        :param camera_motion:</span>
<span class="sd">            Camera breakpoint poses over time, as a list of</span>
<span class="sd">            `CameraMotionBreakpointType` dict. Here is an example::</span>

<span class="sd">                [{&#39;t&#39;: 0.0,</span>
<span class="sd">                  &#39;pose&#39;: ([3.5, 0.0, 1.4], [1.4, 0.0, np.pi / 2])},</span>
<span class="sd">                 {&#39;t&#39;: 0.3,</span>
<span class="sd">                  &#39;pose&#39;: ([4.5, 0.0, 1.4], [1.4, np.pi / 6, np.pi / 2])},</span>
<span class="sd">                 {&#39;t&#39;: 0.6,</span>
<span class="sd">                  &#39;pose&#39;: ([8.5, 0.0, 1.4], [1.4, np.pi / 3, np.pi / 2])},</span>
<span class="sd">                 {&#39;t&#39;: 1.0,</span>
<span class="sd">                  &#39;pose&#39;: ([9.5, 0.0, 1.4], [1.4, np.pi / 2, np.pi / 2])}]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t_camera</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
            <span class="n">camera_break</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">camera_break</span> <span class="ow">in</span> <span class="n">camera_motion</span><span class="p">])</span>
        <span class="n">camera_xyzrpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">camera_break</span><span class="p">[</span><span class="s1">&#39;pose&#39;</span><span class="p">])</span>
                                  <span class="k">for</span> <span class="n">camera_break</span> <span class="ow">in</span> <span class="n">camera_motion</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_motion</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>  <span class="c1"># type: ignore[assignment, return-value]</span>
                <span class="n">interp1d</span><span class="p">(</span><span class="n">t_camera</span><span class="p">,</span> <span class="n">camera_xyzrpy</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="mi">2</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Viewer.remove_camera_motion">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.remove_camera_motion">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_camera_motion</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove camera motion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_motion</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Viewer.attach_camera">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.attach_camera">[docs]</a>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">attach_camera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">relative</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
                      <span class="n">position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">rotation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">lock_relative_pose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attach the camera to a given robot frame.</span>

<span class="sd">        Only the position of the frame is taken into account. A custom relative</span>
<span class="sd">        orientation of the camera wrt to the frame can be further specified. If</span>
<span class="sd">        so, then the relative camera pose wrt the frame is locked, otherwise</span>
<span class="sd">        the camera is only constrained to look at the frame.</span>

<span class="sd">        :param relative: Name or index of the frame of the robot to follow with</span>
<span class="sd">                         the camera.</span>
<span class="sd">        :param position: Relative position [X, Y, Z] of the camera wrt the</span>
<span class="sd">                         tracked frame. It is used to initialize the camera</span>
<span class="sd">                         pose if relative pose is not locked. `None` to</span>
<span class="sd">                         disable.</span>
<span class="sd">                         Optional: Disable by default.</span>
<span class="sd">        :param rotation: Relative orientation [Roll, Pitch, Yaw] of the camera</span>
<span class="sd">                         wrt the tracked frame. It is used to initialize the</span>
<span class="sd">                         camera pose if relative pose is not locked. `None` to</span>
<span class="sd">                         disable.</span>
<span class="sd">                         Optional: Disable by default.</span>
<span class="sd">        :param lock_relative_pose: Whether to lock the relative pose of the</span>
<span class="sd">                                   camera wrt tracked frame.</span>
<span class="sd">                                   Optional: False by default iif Panda3d</span>
<span class="sd">                                   backend is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure one is not trying to track the camera itself</span>
        <span class="k">assert</span> <span class="n">relative</span> <span class="o">!=</span> <span class="s1">&#39;camera&#39;</span><span class="p">,</span> <span class="s2">&quot;Impossible to track the camera itself !&quot;</span>

        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Make sure the frame exists and it is not the universe itself</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relative</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getFrameId</span><span class="p">(</span><span class="n">relative</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">relative</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nframes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trying to attach camera to non-existing frame.&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">relative</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Impossible to track the universe !&quot;</span>

        <span class="c1"># Handle of default camera lock mode</span>
        <span class="k">if</span> <span class="n">lock_relative_pose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lock_relative_pose</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">)</span>

        <span class="c1"># Make sure camera lock mode is compatible with viewer backend</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lock_relative_pose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Not locking camera pose is only supported by Panda3d.&quot;</span><span class="p">)</span>

        <span class="c1"># Set default relative camera pose if pose is partially defined</span>
        <span class="k">if</span> <span class="n">lock_relative_pose</span> <span class="ow">or</span> <span class="n">position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">DEFAULT_CAMERA_XYZRPY_REL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rotation</span> <span class="o">=</span> <span class="n">DEFAULT_CAMERA_XYZRPY_REL</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Set camera pose if relative pose is not locked but provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lock_relative_pose</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_camera_transform</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">relative</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relative</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getFrameId</span><span class="p">(</span><span class="n">relative</span><span class="p">)</span>
            <span class="n">position</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">get_camera_lookat</span><span class="p">()</span> <span class="o">-</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">oMf</span><span class="p">[</span><span class="n">relative</span><span class="p">]</span><span class="o">.</span><span class="n">translation</span><span class="p">)</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_travelling</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;viewer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;frame&#39;</span><span class="p">:</span> <span class="n">relative</span><span class="p">,</span> <span class="s1">&#39;pose&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">rotation</span><span class="p">)}</span></div>


<div class="viewcode-block" id="Viewer.detach_camera">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.detach_camera">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">detach_camera</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detach the camera.</span>

<span class="sd">        Must be called to undo `attach_camera`, so that it will stop</span>
<span class="sd">        automatically tracking a frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_travelling</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Viewer.set_color">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.set_color">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">set_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple4FType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override the color of the visual and collision geometries of the</span>
<span class="sd">        robot on-the-fly.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method is only supported by Panda3d for now.</span>

<span class="sd">        :param color: Color of the robot. It will override the original color</span>
<span class="sd">                      of the meshes if not `None`, and restore them otherwise.</span>
<span class="sd">                      It supports both RGBA codes as a list of 4 floating-point</span>
<span class="sd">                      values ranging from 0.0 and 1.0, and a few named colors.</span>
<span class="sd">                      Optional: Disabled by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Return early if this method is not supported by the current backend</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;This method is only supported by Panda3d.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Sanitize user-specified color code</span>
        <span class="n">color_</span> <span class="o">=</span> <span class="n">get_color_code</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

        <span class="c1"># Update the color of all the geometries of the robot</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">geom_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">visual_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">collision_model</span><span class="p">),</span>
                <span class="n">pin</span><span class="o">.</span><span class="n">GeometryType</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">geometryObjects</span><span class="p">:</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">getViewerNodeName</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">geom_type</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">color_</span>
                <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">geom</span><span class="o">.</span><span class="n">overrideMaterial</span><span class="p">:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">meshColor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">set_material</span><span class="p">(</span><span class="o">*</span><span class="n">node_name</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>

        <span class="c1"># Backup the new color</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span> <span class="ow">in</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_color</span> <span class="o">=</span> <span class="n">color_</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_robot_colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_</span>

        <span class="c1"># Refresh the legend accordingly</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">set_legend</span><span class="p">()</span></div>


<div class="viewcode-block" id="Viewer.update_floor">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.update_floor">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">update_floor</span><span class="p">(</span><span class="n">geom</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">hppfcl</span><span class="o">.</span><span class="n">CollisionGeometry</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">show_vertices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display a custom ground profile as a height map or the original tile</span>
<span class="sd">        ground floor.</span>

<span class="sd">        :param geom: Collision geometry associated with the ground profile. A</span>
<span class="sd">                     flat tile ground will be rendered if not specified. Note</span>
<span class="sd">                     that symbolic function `jiminy_py.core.HeightmapFunction`</span>
<span class="sd">                     can be converted in collision geometry by calling</span>
<span class="sd">                     `jiminy_py.core.discretize_heightmap`.</span>
<span class="sd">                     Optional: None by default.</span>
<span class="sd">        :param show_vertices: Whether to highlight the mesh vertices.</span>
<span class="sd">                              Optional: disabled by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=import-outside-toplevel</span>

        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Render original flat tile ground if possible.</span>
        <span class="c1"># TODO: Improve this check using LocalAABB box geometry instead.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">hppfcl</span><span class="o">.</span><span class="n">Halfspace</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Rendering flat ground with non-zero height not supported&quot;</span><span class="p">)</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Render ground geometry</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">convert_bvh_collision_geometry_to_primitive</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">update_floor</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">show_vertices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.meshcat.meshcat_visualizer</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">update_floor</span> <span class="k">as</span> <span class="n">meshcat_update_floor</span><span class="p">)</span>
            <span class="n">meshcat_update_floor</span><span class="p">(</span><span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span></div>


<div class="viewcode-block" id="Viewer.add_camera">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.add_camera">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">add_camera</span><span class="p">(</span><span class="n">camera_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">is_depthmap</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a RGB or depth camera to the scene.</span>

<span class="sd">        Manually added cameras are mainly useful for simulating exteroceptive</span>
<span class="sd">        sensors. The user is responsible for managing them, i.e. to set their</span>
<span class="sd">        respective poses in world, to get screenshot from them, and to remove</span>
<span class="sd">        them when no longer relevant.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method is only supported by Panda3d for now.</span>

<span class="sd">        :param camera_name: Name of the camera to be added.</span>
<span class="sd">        :param width: Width ofthe image captured by the camera in pixels.</span>
<span class="sd">        :param height: Height of the image captured by the camera in pixels.</span>
<span class="sd">        :param is_depthmap: Whether the camera output gathers 3 8-bits integers</span>
<span class="sd">                            RGB channels or 1 32-bits floats depth channel.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Make sure the backend supports this method</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;This method is only supported by Panda3d.&quot;</span><span class="p">)</span>

        <span class="c1"># Add camera</span>
        <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">add_camera</span><span class="p">(</span>
            <span class="n">camera_name</span><span class="p">,</span> <span class="n">is_depthmap</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span></div>


<div class="viewcode-block" id="Viewer.capture_frame">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.capture_frame">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">capture_frame</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">camera_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">raw_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take a snapshot and return associated data.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Specifying a camera name is only supported by Panda3d rendering</span>
<span class="sd">            backend, while raw data mode is only supported by Meshcat.</span>

<span class="sd">        :param width: Width for the image in pixels. None to keep unchanged.</span>
<span class="sd">                      Optional: Kept unchanged by default.</span>
<span class="sd">        :param height: Height for the image in pixels. None to keep unchanged.</span>
<span class="sd">                       Optional: Kept unchanged by default.</span>
<span class="sd">        :param camera_name: Name of the camera to consider. None to specify</span>
<span class="sd">                            the &quot;default&quot; world facing camera that is used</span>
<span class="sd">                            when GUI (onscreen window) in enabled.</span>
<span class="sd">                            Optional: None by default.</span>
<span class="sd">        :param raw_data: Whether to return a 2D numpy array, or the raw output</span>
<span class="sd">                         from the backend as bytes array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Check user arguments</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">camera_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Resize window if size has changed</span>
                <span class="n">_width</span><span class="p">,</span> <span class="n">_height</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">_width</span>
                <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">_height</span>
                <span class="k">if</span> <span class="n">_width</span> <span class="o">!=</span> <span class="n">width</span> <span class="ow">or</span> <span class="n">_height</span> <span class="o">!=</span> <span class="n">height</span><span class="p">:</span>
                    <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">set_window_size</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Specifying both camera name and image width and/or &quot;</span>
                    <span class="s2">&quot;height is not supported.&quot;</span><span class="p">)</span>

            <span class="c1"># Get screenshot</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">get_screenshot</span><span class="p">(</span><span class="n">camera_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Impossible to capture frame. There is something wrong &quot;</span>
                    <span class="s2">&quot;with the graphics stack on this machine.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">image</span>

        <span class="c1"># Make sure that no camera name has been specified for meshcat</span>
        <span class="k">if</span> <span class="n">camera_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Specifying a camera name is only supported by Panda3d.&quot;</span><span class="p">)</span>

        <span class="c1"># Send capture frame request to the background recorder process</span>
        <span class="n">img_html</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">capture_frame</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

        <span class="c1"># Parse the output to remove the html header, and convert it into</span>
        <span class="c1"># the desired output format.</span>
        <span class="n">img_data</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">img_html</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">decodebytes</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span>

        <span class="c1"># Return raw data if requested</span>
        <span class="k">if</span> <span class="n">raw_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">buffer</span>

        <span class="c1"># Extract numpy array RGBA</span>
        <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>
        <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span> <span class="k">as</span> <span class="n">img_obj</span><span class="p">:</span>
            <span class="n">rgba_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_obj</span><span class="p">)</span>

        <span class="c1"># Return numpy array RGB</span>
        <span class="k">return</span> <span class="n">rgba_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="Viewer.save_frame">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.save_frame">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">save_frame</span><span class="p">(</span><span class="n">image_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a snapshot in png format.</span>

<span class="sd">        :param image_path: Fullpath of the image (.png extension is mandatory)</span>
<span class="sd">        :param width: Width for the image in pixels. None to keep unchanged.</span>
<span class="sd">                      Optional: Kept unchanged by default.</span>
<span class="sd">        :param height: Height for the image in pixels. None to keep unchanged.</span>
<span class="sd">                       Optional: Kept unchanged by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">image_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="n">_width</span><span class="p">,</span> <span class="n">_height</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">_width</span>
            <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">_height</span>
            <span class="k">if</span> <span class="n">_width</span> <span class="o">!=</span> <span class="n">width</span> <span class="ow">or</span> <span class="n">_height</span> <span class="o">!=</span> <span class="n">height</span><span class="p">:</span>
                <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">set_window_size</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">_backend_obj</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">save_screenshot</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img_data</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">capture_frame</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="Viewer.display_visuals">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.display_visuals">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">display_visuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visibility</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the visibility of the visual model of the robot.</span>

<span class="sd">        :param visibility: Whether to enable or disable display of the visual</span>
<span class="sd">                           model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">displayVisuals</span><span class="p">(</span><span class="n">visibility</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>


<div class="viewcode-block" id="Viewer.display_collisions">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.display_collisions">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">display_collisions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visibility</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the visibility of the collision model of the robot.</span>

<span class="sd">        :param visibility: Whether to enable or disable display of the visual</span>
<span class="sd">                           model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">displayCollisions</span><span class="p">(</span><span class="n">visibility</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>


<div class="viewcode-block" id="Viewer.add_marker">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.add_marker">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">add_marker</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">shape</span><span class="p">:</span> <span class="n">ShapeType</span><span class="p">,</span>
            <span class="n">pose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pin</span><span class="o">.</span><span class="n">SE3</span><span class="p">,</span>
                        <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple3FType</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RotationType</span><span class="p">]],</span>
                        <span class="n">Callable</span><span class="p">[[],</span> <span class="n">FramePoseType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">scale</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple3FType</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Tuple3FType</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">color</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple4FType</span><span class="p">]],</span>
                         <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Tuple4FType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">always_foreground</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">remove_if_exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">auto_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">shape_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MarkerDataType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add marker on the scene.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method is only supported by Panda3d.</span>

<span class="sd">        :param name: Unique name. It must be a valid string identifier.</span>
<span class="sd">        :param shape: Desired shape, as a string, i.e. &#39;cone&#39;, &#39;box&#39;, &#39;sphere&#39;,</span>
<span class="sd">                      &#39;capsule&#39;, &#39;cylinder&#39;, &#39;frame&#39;, or &#39;arrow&#39;.</span>
<span class="sd">        :param pose: Pose of the geometry on the scene, as a transform object</span>
<span class="sd">                     `pin.SE3`, or a tuple (position, orientation). In the</span>
<span class="sd">                     latter case, the position must be the vector [X, Y, Z],</span>
<span class="sd">                     while the orientation can be either a rotation matrix, or</span>
<span class="sd">                     a quaternion [X, Y, Z, W]. `None` can be used to specify</span>
<span class="sd">                     neutral frame position and/or orientation.</span>
<span class="sd">                     Optional: Neutral position and orientation by default.</span>
<span class="sd">        :param scale: Size of the marker. Each principal axis of the geometry</span>
<span class="sd">                      are scaled separately.</span>
<span class="sd">        :param color: Color of the marker. It supports both RGBA codes as a</span>
<span class="sd">                      list of 4 floating-point values ranging from 0.0 and 1.0,</span>
<span class="sd">                      and a few named colors.</span>
<span class="sd">                      Optional: Robot&#39;s color by default if overridden, &#39;white&#39;</span>
<span class="sd">                      otherwise, except for &#39;frame&#39;.</span>
<span class="sd">        :param always_foreground: Whether to force rendering the marker on</span>
<span class="sd">                                  foreground.</span>
<span class="sd">                                  Optional: True by default.</span>
<span class="sd">        :param auto_refresh: Whether to refresh the scene after adding the</span>
<span class="sd">                             marker. Useful for adding a bunch of markers and</span>
<span class="sd">                             only refresh once. Note that the marker will not</span>
<span class="sd">                             display properly until then.</span>
<span class="sd">        :param shape_kwargs: Any additional keyword arguments to forward to</span>
<span class="sd">                           `jiminy_py.viewer.panda3d.panda3d_visualizer.`</span>
<span class="sd">                           `Panda3dApp.append_{shape}` for shape instantiation.</span>

<span class="sd">        :returns: Dict of type `MarkerDataType`, storing references to the</span>
<span class="sd">                  current pose, scale, and color of the marker, and itself a</span>
<span class="sd">                  reference to `viewer.markers[name]`. Any modification of it</span>
<span class="sd">                  will take effect at next `refresh` call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Make sure the backend supports this method</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;This method is only supported by Panda3d.&quot;</span><span class="p">)</span>

        <span class="c1"># Handling of user arguments</span>
        <span class="k">if</span> <span class="n">pose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="n">pin</span><span class="o">.</span><span class="n">SE3</span><span class="p">):</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="p">[</span><span class="n">pose</span><span class="o">.</span><span class="n">translation</span><span class="p">,</span> <span class="n">pose</span><span class="o">.</span><span class="n">rotation</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pose</span><span class="p">):</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pose</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pose</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_color</span>
            <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shape</span> <span class="o">!=</span> <span class="s1">&#39;frame&#39;</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">get_color_code</span><span class="p">(</span><span class="n">color</span><span class="p">))</span>

        <span class="c1"># Remove marker is one already exists and requested</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">remove_if_exists</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;marker&#39;s name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_marker</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Add new marker</span>
        <span class="n">create_shape</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;append_</span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">create_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">shape_kwargs</span><span class="p">)</span>
        <span class="n">marker_data</span><span class="p">:</span> <span class="n">MarkerDataType</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;pose&quot;</span><span class="p">:</span> <span class="n">pose</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="n">scale</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">color</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">marker_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_markers_visibility</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Make sure the marker always display in front of the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">show_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">always_foreground</span><span class="o">=</span><span class="n">always_foreground</span><span class="p">)</span>

        <span class="c1"># Refresh the scene if desired</span>
        <span class="k">if</span> <span class="n">auto_refresh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">marker_data</span></div>


<div class="viewcode-block" id="Viewer.display_center_of_mass">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.display_center_of_mass">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">display_center_of_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visibility</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display the position of the center of mass as a sphere.</span>

<span class="sd">        .. note::</span>
<span class="sd">            It corresponds to the attribute `com[0]` of the provided</span>
<span class="sd">            `robot.pinocchio_model`. Calling `Viewer.display` will update it</span>
<span class="sd">            automatically, while `Viewer.refresh` will not.</span>

<span class="sd">        :param visibility: Whether to enable or disable display of the center</span>
<span class="sd">                           of mass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Make sure the current backend is supported by this method.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">visibility</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;This method is only supported by Panda3d.&quot;</span><span class="p">)</span>
            <span class="c1"># Return early if not supported but not requested either.</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;COM_0&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">show_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">visibility</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_markers_visibility</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">visibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_com</span> <span class="o">=</span> <span class="n">visibility</span></div>


<div class="viewcode-block" id="Viewer.display_capture_point">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.display_capture_point">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">display_capture_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visibility</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display the position of the capture point,also called divergent</span>
<span class="sd">        component of motion (DCM) as a sphere.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Calling `Viewer.display` will update it automatically, while</span>
<span class="sd">            `Viewer.refresh` will not.</span>

<span class="sd">        :param visibility: Whether to enable or disable display of the capture</span>
<span class="sd">                           point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Make sure the current backend is supported by this method.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">visibility</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;This method is only supported by Panda3d.&quot;</span><span class="p">)</span>
            <span class="c1"># Return early if not supported but not requested either.</span>
            <span class="k">return</span>

        <span class="c1"># Update visibility</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;DCM&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">show_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">visibility</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_markers_visibility</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">visibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_dcm</span> <span class="o">=</span> <span class="n">visibility</span>

        <span class="c1"># Must refresh the scene</span>
        <span class="k">if</span> <span class="n">visibility</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>


<div class="viewcode-block" id="Viewer.display_contact_frames">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.display_contact_frames">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">display_contact_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visibility</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display the contact frames of the robot as spheres.</span>

<span class="sd">        .. note::</span>
<span class="sd">            The frames to display are specified by the attribute</span>
<span class="sd">            `contact_frame_names` of the provided `robot`. Calling</span>
<span class="sd">            `Viewer.display` will update it automatically, while</span>
<span class="sd">            `Viewer.refresh` will not.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method is only supported by Panda3d.</span>

<span class="sd">        :param visibility: Whether to display the contact frames.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Make sure the current backend is supported by this method.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">visibility</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;This method is only supported by Panda3d.&quot;</span><span class="p">)</span>
            <span class="c1"># Return early if not supported but not requested either.</span>
            <span class="k">return</span>

        <span class="c1"># Update visibility</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ContactFrame&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">show_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">visibility</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_markers_visibility</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">visibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_contact_frames</span> <span class="o">=</span> <span class="n">visibility</span>

        <span class="c1"># Must refresh the scene</span>
        <span class="k">if</span> <span class="n">visibility</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>


<div class="viewcode-block" id="Viewer.display_contact_forces">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.display_contact_forces">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">display_contact_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visibility</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display forces associated with the contact sensors attached to the</span>
<span class="sd">        robot, as cylinders of variable length depending of Fz.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Fz can be signed. It will affect the orientation of the capsule.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            It corresponds to the attribute `data` of `jiminy.ContactSensor`.</span>
<span class="sd">            Calling `Viewer.display` will NOT update its value automatically.</span>
<span class="sd">            It is up to the user to keep it up-to-date.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method is only supported by Panda3d.</span>

<span class="sd">        :param visibility: Whether to display the contact forces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Make sure the current backend is supported by this method.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">visibility</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;This method is only supported by Panda3d.&quot;</span><span class="p">)</span>
            <span class="c1"># Return early if not supported but not requested either.</span>
            <span class="k">return</span>

        <span class="c1"># Update visibility</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ContactSensor</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">show_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">visibility</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_markers_visibility</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">visibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_contact_forces</span> <span class="o">=</span> <span class="n">visibility</span>

        <span class="c1"># Must refresh the scene</span>
        <span class="k">if</span> <span class="n">visibility</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>


<div class="viewcode-block" id="Viewer.display_external_forces">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.display_external_forces">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">display_external_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">visibility</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span>
                                <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display external forces applied on the joints the robot, as arrows</span>
<span class="sd">        of variable length depending of magnitude of the force.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            It only display the linear component of the force, while ignoring</span>
<span class="sd">            the angular part for now.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            It corresponds to the attribute `viewer.f_external`. Calling</span>
<span class="sd">            `Viewer.display` will NOT update its value automatically.  It is up</span>
<span class="sd">            to the user to keep it up-to-date.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method is only supported by Panda3d.</span>

<span class="sd">        :param visibility: Whether to display the external force applied at</span>
<span class="sd">                           each joint selectively. If a boolean is provided,</span>
<span class="sd">                           the same visibility will be set for each joint,</span>
<span class="sd">                           alternatively, one can provide a boolean list whose</span>
<span class="sd">                           ordering is consistent with pinocchio model (i.e.</span>
<span class="sd">                           `pinocchio_model.names`).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert boolean visiblity to mask if necessary</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">visibility</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">visibility</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">njoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">visibility</span><span class="p">,)</span>

        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">visibility</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Make sure the current backend is supported by this method.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">visibility</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;This method is only supported by Panda3d.&quot;</span><span class="p">)</span>
            <span class="c1"># Return early if not supported but not requested either.</span>
            <span class="k">return</span>

        <span class="c1"># Check that the length of the mask is consistent with the model</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">visibility</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">njoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;The length of the visibility mask must be equal to the number of &quot;</span>
            <span class="s2">&quot;joints of the model, &#39;universe&#39; excluded.&quot;</span><span class="p">)</span>

        <span class="c1"># Update visibility</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">njoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ForceExternal_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">show_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">visibility</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_markers_visibility</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">visibility</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_f_external</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">visibility</span><span class="p">)</span>

        <span class="c1"># Must refresh the scene</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">visibility</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>


<div class="viewcode-block" id="Viewer.remove_marker">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.remove_marker">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">remove_marker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a marker, based on its name.</span>

<span class="sd">        :param identifier: Name of the marker to remove.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Marker&#39;s name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; does not exists.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="Viewer.refresh">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.refresh">[docs]</a>
    <span class="nd">@_with_lock</span>
    <span class="nd">@_must_be_open</span>
    <span class="nd">@_is_async</span>
    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">force_update_visual</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">force_update_collision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Refresh the configuration of Robot in the viewer.</span>

<span class="sd">        This method is also in charge of updating the camera placement for</span>
<span class="sd">        travelling.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This method is copy-pasted from `Pinocchio.visualize.*.display`</span>
<span class="sd">            method, after removing parts responsible of update pinocchio</span>
<span class="sd">            data and collision data. Visual data must still be updated.</span>

<span class="sd">        :param force_update_visual: Force update of visual geometries.</span>
<span class="sd">        :param force_update_collision: Force update of collision geometries.</span>
<span class="sd">        :param wait: Whether to wait for rendering to finish.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=invalid-name</span>
        <span class="c1"># Assert(s) for type checker</span>
        <span class="k">assert</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Extract pinocchio model and data pairs to update</span>
        <span class="n">model_list</span><span class="p">,</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">model_type_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">display_collisions</span> <span class="ow">or</span> <span class="n">force_update_collision</span><span class="p">:</span>
            <span class="n">model_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">collision_model</span><span class="p">)</span>
            <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">collision_data</span><span class="p">)</span>
            <span class="n">model_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin</span><span class="o">.</span><span class="n">GeometryType</span><span class="o">.</span><span class="n">COLLISION</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">display_visuals</span> <span class="ow">or</span> <span class="n">force_update_visual</span><span class="p">:</span>
            <span class="n">model_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">visual_model</span><span class="p">)</span>
            <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">visual_data</span><span class="p">)</span>
            <span class="n">model_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin</span><span class="o">.</span><span class="n">GeometryType</span><span class="o">.</span><span class="n">VISUAL</span><span class="p">)</span>

        <span class="c1"># Update geometries placements</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_list</span><span class="p">,</span> <span class="n">data_list</span><span class="p">):</span>
            <span class="n">pin</span><span class="o">.</span><span class="n">updateGeometryPlacements</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># Render new geometries placements</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">geom_model</span><span class="p">,</span> <span class="n">geom_data</span><span class="p">,</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">model_list</span><span class="p">,</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">model_type_list</span><span class="p">):</span>
                <span class="n">pose_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FramePoseType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geom_model</span><span class="o">.</span><span class="n">geometryObjects</span><span class="p">):</span>
                    <span class="n">oMg</span> <span class="o">=</span> <span class="n">geom_data</span><span class="o">.</span><span class="n">oMg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">qz</span><span class="p">,</span> <span class="n">qw</span> <span class="o">=</span> <span class="n">SE3ToXYZQUAT</span><span class="p">(</span><span class="n">oMg</span><span class="p">)</span>
                    <span class="n">group</span><span class="p">,</span> <span class="n">node_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">getViewerNodeName</span><span class="p">(</span>
                        <span class="n">geom</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
                    <span class="n">pose_dict</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="p">(</span><span class="n">qw</span><span class="p">,</span> <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">qz</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">pose_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">move_nodes</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">pose_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">umsgpack</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>
            <span class="n">cmd_data</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;list&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">geom_model</span><span class="p">,</span> <span class="n">geom_data</span><span class="p">,</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">model_list</span><span class="p">,</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">model_type_list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geom_model</span><span class="o">.</span><span class="n">geometryObjects</span><span class="p">):</span>
                    <span class="n">oMg</span> <span class="o">=</span> <span class="n">geom_data</span><span class="o">.</span><span class="n">oMg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">((</span><span class="o">*</span><span class="n">geom</span><span class="o">.</span><span class="n">meshScale</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
                    <span class="n">H</span> <span class="o">=</span> <span class="n">oMg</span><span class="o">.</span><span class="n">homogeneous</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
                    <span class="n">node_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">getViewerNodeName</span><span class="p">(</span>
                        <span class="n">geom</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">cmd_data</span> <span class="o">+=</span> <span class="p">[</span>
                        <span class="sa">b</span><span class="s2">&quot;set_transform&quot;</span><span class="p">,</span>
                        <span class="n">path</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
                        <span class="n">umsgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">({</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;set_transform&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                            <span class="s2">&quot;matrix&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>
                        <span class="p">})</span>
                    <span class="p">]</span>
            <span class="c1"># Moving all geometries at once using custom command to improve</span>
            <span class="c1"># throughput due to piping sockets with multiple redirections.</span>
            <span class="k">if</span> <span class="n">cmd_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">zmq_socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">(</span><span class="n">cmd_data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">zmq_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

        <span class="c1"># Update the camera placement if necessary</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_travelling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_travelling</span><span class="p">[</span><span class="s1">&#39;viewer&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">position</span><span class="p">,</span> <span class="n">rotation</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_travelling</span><span class="p">[</span><span class="s1">&#39;pose&#39;</span><span class="p">]</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_travelling</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">rotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_camera_transform</span><span class="p">(</span>
                        <span class="n">position</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_camera_lookat</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_motion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_camera_transform</span><span class="p">(</span><span class="o">*</span><span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_xyzrpy</span><span class="p">)</span>

        <span class="c1"># Update pose, color and scale of the markers, if any</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
            <span class="n">pose_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">material_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple4FType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">scale_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple3FType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">marker_name</span><span class="p">,</span> <span class="n">marker_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Skip marker that are not visible for speedup</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_markers_visibility</span><span class="p">[</span><span class="n">marker_name</span><span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="c1"># Pose processing</span>
                <span class="n">pose</span> <span class="o">=</span> <span class="n">marker_data</span><span class="p">[</span><span class="s2">&quot;pose&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">pose</span><span class="p">):</span>
                    <span class="n">pose</span> <span class="o">=</span> <span class="n">pose</span><span class="p">()</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="n">pose</span>
                <span class="k">if</span> <span class="n">orientation</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">qz</span><span class="p">,</span> <span class="n">qw</span> <span class="o">=</span> <span class="n">pin</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span><span class="o">.</span><span class="n">coeffs</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">qz</span><span class="p">,</span> <span class="n">qw</span> <span class="o">=</span> <span class="n">orientation</span>
                <span class="n">pose_dict</span><span class="p">[</span><span class="n">marker_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="p">(</span><span class="n">qw</span><span class="p">,</span> <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">qz</span><span class="p">))</span>

                <span class="c1"># Color processing</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">marker_data</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">color</span>
                    <span class="n">material_dict</span><span class="p">[</span><span class="n">marker_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">r</span><span class="p">,</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">g</span><span class="p">,</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

                <span class="c1"># Scale processing</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">marker_data</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">scale</span><span class="p">):</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="p">()</span>
                <span class="n">scale_dict</span><span class="p">[</span><span class="n">marker_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">move_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">pose_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">set_materials</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">material_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">set_scales</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers_group</span><span class="p">,</span> <span class="n">scale_dict</span><span class="p">)</span>

        <span class="c1"># Wait for the backend viewer to finish rendering if requested</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">Viewer</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">require_client</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="Viewer.display">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.display">[docs]</a>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">q</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">v</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">xyz_offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">update_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the configuration of the robot.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            It will alter original robot data if viewer attribute</span>
<span class="sd">            `use_theoretical_model` is false.</span>

<span class="sd">        :param q: Configuration of the robot.</span>
<span class="sd">        :param v: Velocity of the robot. Used only to update velocity</span>
<span class="sd">                  dependent markers such as DCM. `None` if undefined.</span>
<span class="sd">                  Optional: `None` by default.</span>
<span class="sd">        :param xyz_offset: Freeflyer position offset. Note that it does not</span>
<span class="sd">                           check for the robot actually have a freeflyer.</span>
<span class="sd">        :param update_hook: Callable that will be called right after updating</span>
<span class="sd">                            kinematics data. `None` to disable.</span>
<span class="sd">                            Optional: None by default.</span>
<span class="sd">        :param wait: Whether to wait for rendering to finish.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nq</span><span class="p">,)</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span>
            <span class="s2">&quot;The configuration vector does not have the right size.&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure the state is valid</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input state (&#39;q&#39;,&#39;v&#39;) contains &#39;nan&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Apply offset on the freeflyer, if requested.</span>
        <span class="c1"># Note that it is NOT checking that the robot has a freeflyer.</span>
        <span class="k">if</span> <span class="n">xyz_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Make a copy to avoid altering the original data</span>
            <span class="n">q</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">xyz_offset</span>

        <span class="c1"># Update pinocchio data</span>
        <span class="n">pin</span><span class="o">.</span><span class="n">framesForwardKinematics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pin</span><span class="o">.</span><span class="n">centerOfMass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pin</span><span class="o">.</span><span class="n">centerOfMass</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Call custom update hook</span>
        <span class="k">if</span> <span class="n">update_hook</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_hook</span><span class="p">()</span>

        <span class="c1"># Refresh the viewer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span></div>


<div class="viewcode-block" id="Viewer.replay">
<a class="viewcode-back" href="../../../api/jiminy_py/viewer.html#jiminy_py.viewer.Viewer.replay">[docs]</a>
    <span class="nd">@_must_be_open</span>
    <span class="k">def</span> <span class="nf">replay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">trajectory</span><span class="p">:</span> <span class="n">Trajectory</span><span class="p">,</span>
               <span class="n">time_interval</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
               <span class="n">speed_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
               <span class="n">xyz_offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">update_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UpdateHook</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">enable_clock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
               <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replay a complete robot trajectory at a given real-time ratio.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Specifying &#39;udpate_hook&#39; is necessary to be able to display sensor</span>
<span class="sd">            information such as contact forces. It will be automatically</span>
<span class="sd">            disable otherwise.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            It will alter original robot data if viewer attribute</span>
<span class="sd">            `use_theoretical_model` is false.</span>

<span class="sd">        :param states: Sequence of `State` objects of increasing time.</span>
<span class="sd">        :param time_interval: Specific time interval to replay.</span>
<span class="sd">                              Optional: Complete evolution by default [0, inf].</span>
<span class="sd">        :param speed_ratio: Real-time factor.</span>
<span class="sd">                            Optional: No time dilation by default (1.0).</span>
<span class="sd">        :param xyz_offset: Freeflyer position offset. Note that it does not</span>
<span class="sd">                           check for the robot actually have a freeflyer.</span>
<span class="sd">                           Optional: None by default.</span>
<span class="sd">        :param update_hook:</span>
<span class="sd">            Callable that will be called periodically between every state</span>
<span class="sd">            update. `None` to disable, otherwise it must have the following</span>
<span class="sd">            signature:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                f(t:float, q: ndarray, v: Optional[ndarray]) -&gt; None</span>

<span class="sd">            Optional: No update hook by default.</span>
<span class="sd">        :param wait: Whether to wait for rendering to finish.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Early return if nothing to replay</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">has_data</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Sanitize replay time interval</span>
        <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">time_interval</span>
        <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_start</span><span class="p">),</span> <span class="n">t_end</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_interval</span><span class="p">)</span>

        <span class="c1"># Disable display of sensor data if no update hook is provided</span>
        <span class="n">disable_display_contact_forces</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">update_hook</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_contact_forces</span><span class="p">:</span>
            <span class="n">disable_display_contact_forces</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_contact_forces</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Disable display of DCM if no velocity data provided</span>
        <span class="n">disable_display_dcm</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">has_velocity</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_dcm</span><span class="p">:</span>
            <span class="n">disable_display_dcm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_capture_point</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Replay the whole trajectory at constant speed ratio</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t_start</span>
        <span class="n">time_init</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">time_prev</span> <span class="o">=</span> <span class="n">time_init</span>
        <span class="n">update_hook_t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Update clock if enabled</span>
                <span class="k">if</span> <span class="n">enable_clock</span><span class="p">:</span>
                    <span class="n">Viewer</span><span class="o">.</span><span class="n">set_clock</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

                <span class="c1"># Compute state at current time</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>

                <span class="c1"># Update viewer force buffer</span>
                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">f_external</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">f_ref</span><span class="p">,</span> <span class="n">f_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">f_external</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">f_external</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                        <span class="n">f_ref</span><span class="o">.</span><span class="n">vector</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">f_i</span>

                <span class="c1"># Update camera motion</span>
                <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_motion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_xyzrpy</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">_camera_motion</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

                <span class="c1"># Update display</span>
                <span class="k">if</span> <span class="n">update_hook</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">update_hook_t</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">update_hook</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">xyz_offset</span><span class="p">,</span> <span class="n">update_hook_t</span><span class="p">,</span> <span class="n">wait</span><span class="p">)</span>

                <span class="c1"># Sleep for a while if computing faster than display framerate</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">REPLAY_FRAMERATE</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_prev</span><span class="p">))</span>
                <span class="n">time_prev</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Break replay loop if the final time has been reached</span>
                <span class="k">if</span> <span class="n">t_end</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># Update simulation time, taking into account speed ratio</span>
                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time_prev</span> <span class="o">-</span> <span class="n">time_init</span>
                <span class="n">t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t_start</span> <span class="o">+</span> <span class="n">speed_ratio</span> <span class="o">*</span> <span class="n">time_elapsed</span><span class="p">,</span> <span class="n">t_end</span><span class="p">)</span>

                <span class="c1"># Waiting for the first timestep is enough</span>
                <span class="n">wait</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Get backend info to analyze the root cause of the exception</span>
                <span class="n">backend</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">backend</span>
                <span class="n">is_open</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span><span class="p">()</span>  <span class="c1"># type: ignore[misc]</span>

                <span class="c1"># If no backend, probably it has been closed in the meantime</span>
                <span class="c1"># during multi-threaded replay. So just return without error.</span>
                <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="c1"># Make sure the viewer is always properly closed</span>
                <span class="n">Viewer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c1"># Once again, the backend was most likely killed on purpose</span>
                <span class="c1"># during multi-threaded replay. Returning without error.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_open</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="c1"># Re-raise the original exception if unexpected</span>
                <span class="k">if</span> <span class="n">backend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;panda3d&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ViewerClosedError</span><span class="p">):</span>
                        <span class="k">return</span>
                <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;meshcat&#39;</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">zmq</span>  <span class="c1"># pylint: disable=import-outside-toplevel</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Again</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ZMQError</span><span class="p">)):</span>
                        <span class="k">return</span>
                <span class="k">raise</span>

        <span class="c1"># Restore Viewer&#39;s state if it has been altered</span>
        <span class="k">if</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="c1"># Disable clock after replay if enabled</span>
            <span class="k">if</span> <span class="n">enable_clock</span><span class="p">:</span>
                <span class="n">Viewer</span><span class="o">.</span><span class="n">set_clock</span><span class="p">()</span>

            <span class="c1"># Restore display if necessary</span>
            <span class="k">if</span> <span class="n">disable_display_contact_forces</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display_contact_forces</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">disable_display_dcm</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display_capture_point</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Alexis Duburcq - MIT licence.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>