<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>MeshCat</title>
	</head>
	<body>
        <div id="meshcat-pane"></div>

        <script type="text/javascript" src="main.min.js"></script>
        <script>
            var viewer = new MeshCat.Viewer(document.getElementById("meshcat-pane"), false);

            var meshes_loaded = 0;
            var set_object_from_json = viewer.set_object_from_json;
            viewer.set_object_from_json = function(path, object_json) {
                set_object_from_json.call(this, path, object_json);
                meshes_loaded += 1;
            };

            var handle_command = viewer.handle_command;
            viewer.handle_command = function(cmd) {
                if (cmd.type == "meshes_loaded") {
                    this.connection.send(meshes_loaded);
                } else {
                    handle_command.call(this, cmd);
                }
            };

            try {
                viewer.connect();
            } catch (e) {
                console.info("Not connected to MeshCat websocket server: ", e);
            }

            var segments = 20;
            var geometry = new MeshCat.THREE.PlaneGeometry(20, 20, segments, segments);
            var materialEven = new MeshCat.THREE.MeshBasicMaterial(
                {color: 0x222233, side: MeshCat.THREE.DoubleSide});
            var materialOdd = new MeshCat.THREE.MeshBasicMaterial(
                {color: 0xf2f2fe, side: MeshCat.THREE.DoubleSide});
            var materials = [materialEven, materialOdd]
            for (x of [...Array(segments).keys()]) {
                for (y of [...Array(segments).keys()]) {
                    i = x * segments + y;
                    j = 2 * i;
                    geometry.faces[j].materialIndex = geometry.faces[j + 1].materialIndex = (x + y) % 2;
                }
            }
            var checkerboard = new MeshCat.THREE.Mesh(geometry, materials);
            viewer.scene_tree.find(["Grid"]).set_object(checkerboard)

            viewer.scene_tree.find(["Axes", "<object>"]).object.material.linewidth = 2.5

            viewer.camera.fov = 30;
            viewer.render();

            function animate() {
                requestAnimationFrame(animate);
                viewer.animator.update();
                if (viewer.needs_render) {
                    viewer.camera.updateProjectionMatrix();
                    viewer.renderer.render(viewer.scene, viewer.camera);
                    viewer.animator.after_render();
                    viewer.needs_render = false;
                }
            }
            animate();
        </script>

        <style>
            body {
                margin: 0;
            }

            #meshcat-pane {
                width: 100vw;
                height: 100vh;
                overflow: hidden;
            }
        </style>
        <script id="embedded-json"></script>
	</body>
</html>
